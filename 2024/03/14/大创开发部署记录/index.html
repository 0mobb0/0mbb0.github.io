<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>大创开发部署记录 | All about secret</title><meta name="author" content="mobb"><meta name="copyright" content="mobb"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="部署k8s1.23.8初始工作安装ssh 12345sudo apt install openssh-serversudo systemctl start ssh #开启sudo systemctl status sshd #查看状态sudo ps -e | grep ssh #查看是否开启  安装完之后可以使用xshell或是Mobaxterm来进行ssh连接，为了保证以后在物理机上部署集群需要">
<meta property="og:type" content="article">
<meta property="og:title" content="大创开发部署记录">
<meta property="og:url" content="http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="All about secret">
<meta property="og:description" content="部署k8s1.23.8初始工作安装ssh 12345sudo apt install openssh-serversudo systemctl start ssh #开启sudo systemctl status sshd #查看状态sudo ps -e | grep ssh #查看是否开启  安装完之后可以使用xshell或是Mobaxterm来进行ssh连接，为了保证以后在物理机上部署集群需要">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/1.jpg">
<meta property="article:published_time" content="2024-03-14T14:49:36.000Z">
<meta property="article:modified_time" content="2024-03-20T16:13:57.405Z">
<meta property="article:author" content="mobb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '大创开发部署记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-21 00:13:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/1.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">All about secret</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">大创开发部署记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-14T14:49:36.000Z" title="发表于 2024-03-14 22:49:36">2024-03-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-20T16:13:57.405Z" title="更新于 2024-03-21 00:13:57">2024-03-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="大创开发部署记录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="部署k8s1-23-8"><a href="#部署k8s1-23-8" class="headerlink" title="部署k8s1.23.8"></a>部署k8s1.23.8</h1><h2 id="初始工作"><a href="#初始工作" class="headerlink" title="初始工作"></a>初始工作</h2><p>安装ssh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-server</span><br><span class="line">sudo systemctl start ssh <span class="comment">#开启</span></span><br><span class="line"></span><br><span class="line">sudo systemctl status sshd <span class="comment">#查看状态</span></span><br><span class="line">sudo ps -e | grep ssh <span class="comment">#查看是否开启</span></span><br></pre></td></tr></table></figure>

<p>安装完之后可以使用xshell或是Mobaxterm来进行ssh连接，为了保证以后在物理机上部署集群需要使用物理机，所以我使用ssh来进行远程部署模拟</p>
<p>1.首先关闭防火墙</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914132040660.png" alt="image-20230914132040660"></p>
<h2 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab <span class="comment">#永久关闭</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914132119011.png" alt="image-20230914132119011"></p>
<p>想要恢复swap可以使用以下命令恢复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -ri <span class="string">&#x27;s/#(.*swap.*)/\1/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<p>在master上添加hosts，这里要切换root用户，才能追加，如果直接vim编辑则只需要sudo就行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">10.12.52.66 lab1</span></span><br><span class="line"><span class="string">10.12.52.67 lab2</span></span><br><span class="line"><span class="string">10.12.52.68 lab3</span></span><br><span class="line"><span class="string">10.12.52.70 lab4</span></span><br><span class="line"><span class="string">10.12.52.71 lab5</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.52.51 lab1</span></span><br><span class="line"><span class="string">192.168.52.52 lab2</span></span><br><span class="line"><span class="string">192.168.52.53 lab3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.52.134 lab1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>添加完记得查看一下</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914132513118.png" alt="image-20230914132513118"></p>
<p>将桥接的 IPv4 流量传递到iptables的链</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s_better.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances=8192</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=1048576</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6=1</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=2310720</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914132726340.png" alt="image-20230914132726340"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modprobe br_netfilter 和 lsmod | grep conntrack 是用于加载 br_netfilter 模块和检查 conntrack 模块是否已加载。</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line">lsmod |grep conntrack</span><br><span class="line">modprobe ip_conntrack</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914132738371.png" alt="image-20230914132738371"></p>
<h2 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ntp</span><br><span class="line"> //安装ntp服务</span><br><span class="line"></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> ntp</span><br><span class="line"> //开机启动服务</span><br><span class="line"></span><br><span class="line">sudo systemctl start ntp</span><br><span class="line"> //启动服务</span><br><span class="line"></span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br><span class="line"> //更改时区</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ntpq -p</span><br><span class="line"> //同步时间</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="使用sealos安装k8s"><a href="#使用sealos安装k8s" class="headerlink" title="使用sealos安装k8s"></a>使用sealos安装k8s</h2><p>首先对除了master节点之外的其他节点的ssh配置文件进行更改，因为默认的ssh连接是不允许root用户登录的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">PermitRootLogin yes               <span class="comment"># 允许root用户以任何认证方式登录</span></span><br><span class="line">PermitRootLogin prohibit-password <span class="comment"># 只允许root用户用public key 方式登录验证</span></span><br><span class="line">PermitRootLogin no                <span class="comment"># 不允许root用户以任何认证方式登录</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914173210318.png" alt="image-20230914173210318"></p>
<p>然后重启ssh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<p>然后运行下面的命令安装k8s，这里sealos默认安装的网络插件是calico</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> sealos run labring/kubernetes-docker:v1.23.8 labring/helm:v3.8.2 labring/calico:v3.24.1      --masters 10.12.52.66      --nodes 10.12.52.67,10.12.52.68 -p 123456</span><br><span class="line"> </span><br><span class="line">sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes:v1.23.8 registry.cn-shanghai.aliyuncs.com/labring/helm:v3.8.2 registry.cn-shanghai.aliyuncs.com/labring/calico:v3.24.1 \</span><br><span class="line">     --masters 192.168.52.134</span><br><span class="line">     </span><br><span class="line">sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes:v1.21.2 registry.cn-shanghai.aliyuncs.com/labring/helm:v3.6.2 registry.cn-shanghai.aliyuncs.com/labring/calico:v3.20.1      --masters 192.168.52.134.cn-sh </span><br></pre></td></tr></table></figure>

<p>虚拟机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos run labring/kubernetes-docker:v1.23.8 labring/helm:v3.8.2 labring/calico:v3.24.1      --masters 192.168.52.51      --nodes 192.168.52.52,192.168.52.53 -p 123456</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914172347434.png" alt="image-20230914172347434"></p>
<p>可能会遇到这样的报错，一直重试就成功了</p>
<p>安装成功的界面是这样的</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914172508954.png" alt="image-20230914172508954"></p>
<p>翻一下安装的log可以看到</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914172641078.png" alt="image-20230914172641078"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join apiserver.cluster.local:6443 --token &lt;value withheld&gt; \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:6fc5b6c10252cdfe5ce4d4790b8be43a14e4514cdeef49d0b791cb7a33bdd6de \</span><br><span class="line">        --control-plane --certificate-key &lt;value withheld&gt;</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join apiserver.cluster.local:6443 --token &lt;value withheld&gt; \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:6fc5b6c10252cdfe5ce4d4790b8be43a14e4514cdeef49d0b791cb7a33bdd6de</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>虽然使用sealos不需要kubeadm了，但是还是记录下来了</p>
<p>增加节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos add --nodes 10.12.52.70,10.12.52.71 -p 123456 </span><br></pre></td></tr></table></figure>

<p>如果遇到了说端口监管不正确的地方就把端口改成22，比如这样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos add --nodes 10.12.52.70:22,10.12.52.71:22 -p 123456 </span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914173920669.png" alt="image-20230914173920669"></p>
<p>这样就安装完成了</p>
<h2 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h2><p>对应自己的k8s版本下载对应的dashboard，此处下载的是2.5.1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914185404098.png" alt="image-20230914185404098"></p>
<p>查看一下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc --all-namespaces</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914204636763-16946955977341.png" alt="image-20230914204636763"></p>
<p>虚拟机</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231126121110161.png" alt="image-20231126121110161"></p>
<p>删除现有的service，因为后续要改成NODEPORT</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete service kubernetes-dashboard --namespace=kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p>创建配置文件<code>dashboard-svc.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/k8sdashboard<span class="comment"># kubectl apply -f dashboard-svc.yaml</span></span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">root@lab1:/home/lab1/k8sdashboard<span class="comment"># kubectl get svc --all-namespaces</span></span><br><span class="line">NAMESPACE              NAME                              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">calico-apiserver       calico-api                        ClusterIP   10.96.2.184   &lt;none&gt;        443/TCP                  6h5m</span><br><span class="line">calico-system          calico-kube-controllers-metrics   ClusterIP   10.96.3.135   &lt;none&gt;        9094/TCP                 6h5m</span><br><span class="line">calico-system          calico-typha                      ClusterIP   10.96.3.94    &lt;none&gt;        5473/TCP                 6h6m</span><br><span class="line">default                kubernetes                        ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP                  6h8m</span><br><span class="line">kube-system            kube-dns                          ClusterIP   10.96.0.10    &lt;none&gt;        53/UDP,53/TCP,9153/TCP   6h7m</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper         ClusterIP   10.96.3.104   &lt;none&gt;        8000/TCP                 120m</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard              NodePort    10.96.2.221   &lt;none&gt;        443:30601/TCP            4s</span><br><span class="line">root@lab1:/home/lab1/k8sdashboard<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914205125605.png" alt="image-20230914205125605"></p>
<p>创建 kubernetes-dashboard 管理员角色，<code>dashboard-svc-account.yaml</code>内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/k8sdashboard# vim dashboard-svc-account.yaml</span><br><span class="line">root@lab1:/home/lab1/k8sdashboard# kubectl apply -f dashboard-svc-account.yaml</span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>获取token</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/k8sdashboard<span class="comment"># kubectl get secret -n kubernetes-dashboard |grep admin|awk &#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line">admin-user-token-hcr5p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 dashboard]<span class="comment"># kubectl describe secret admin-user-token-hcr5p -n kubernetes-dashboard|grep &#x27;^token&#x27;|awk &#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6Im9VLUFMQ2g0OWZxcEw0enVkS0VHbHRrVnU4d0lJTFlWcXhMYi1PMEl3eU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWhjcjVwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1ZmRiZTFjMC1mMWMzLTRkM2YtYWNlMi0xM2ZhNDZiMTRmNDYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.nChnvqiqFeXuTnMCW0y-m8KbR5KEyovjr7K0z32jkb88yvFTlQv50HyI8Y2fZ9fJ6qAeT3nIuZtcScbaS_bwi_PwvtwlItgjQhT09Hw8cpKLgts4FXLYwEGrm6Gyf2QIExuLf8JHjp_arBRTkY4uDHTeNVFx8AzCTFJEZ6EOoy7lYYGUcRIEkAQ5mU1N5kW-043_ufN9NwpeFi3DIcAlHofTrW9b7UqgbUTjJUxcanpqkc95A9C_iFeq9acVoMuNC_HSJVIcfeIXtZcmxY6e-JezhDdTAqONM8c3TVMelDbmFpPjlT-gIC7g5TXzlsK61RAktV6WLP96XUuyazqpGg</span><br></pre></td></tr></table></figure>

<p>虚拟机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/dashboard<span class="comment"># kubectl get secret -n kubernetes-dashboard |grep admin|awk &#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line">admin-user-token-2x5fq</span><br><span class="line"></span><br><span class="line">root@lab1:/home/lab1/dashboard<span class="comment"># kubectl describe secret admin-user-token-2x5fq -n kubernetes-dashboard|grep &#x27;^token&#x27;|awk &#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkMwdGw3cS1aUGNQV0pMbUxTeDRDMFV0RktvX202SW80c0tMRWp6dl9NRzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTJ4NWZxIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhYTczMzYwMy0xY2VlLTQxMDMtYmVmOS1kMWI0NjVkZTc0NGIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.VoEuzCWU9c8swO3F6WyMVWtT_BKhhucl7ef5ug2AMmlrvNI8bs98Iw8Nf1G6f8-OwpjQKXSzcw9tUPY1745iEPfKBhXIeZ37AtH3HbN-NhpF1xtw4XsKI3-zxq6MOTR__4isF80sZdYoufqTFehkoOXJK4cdjPvhCx8LgFUuyIedHU8KmRCvPKH7kqh4iqN4z1LvTv_KzHmhZe1KmLgp1fEySUl_dN7tCu9-pBBNcU22t5h-UVefujohdDq_p4DWKcr-eZyyBUymsyzMLjcrZOYZnainRkrXwtiQs3DOhIR5SFqDexTsePgAF5jW5iq9TEDOzg_A_OheYQv_wNgcMA</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/dashboard<span class="comment"># kubectl get secret -n kubernetes-dashboard |grep admin|awk &#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line">admin-user-token-vlpnx</span><br><span class="line">root@lab1:/home/lab1/dashboard<span class="comment"># kubectl describe secret admin-user-token-vlpnx -n kubernetes-dashboard|grep &#x27;^token&#x27;|awk &#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkMwdGw3cS1aUGNQV0pMbUxTeDRDMFV0RktvX202SW80c0tMRWp6dl9NRzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXZscG54Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIwYjllMzliMy03MjQ1LTRhYWMtODk3ZC1mNDIzNjFhZWRjNzIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.jz6mZrz53DJr2tgJDgvBwxDuYDnOadq-6qKyC8jZIHWVwgaoLVdObPh6E8RiFnM7MVDOKOWHr5n_KFBpko0vY7qh4wvu6krNeRNi5aI_5whD5dy_L5-wEy6boKz9TUM9BCCTQ3tiI1CSPB-zIKfnTWxueBVoumG4uqC_YYgnIiwk0YqN_-RaM5A2pQo9Zrmz0HSXE6YoExLm1gGj0lmtBFkDjF2-n-ZbQQ1-9Sjz9bR6_QZhzSjQCzZpzwPCH5ODCiEo1BUDg9C88At1UeLAk4AafoWzVfrWP_ixevG9BAxTh93jxgsXXWwO_4Jw_povRuq6KRHab1nDtPisuDrNEA</span><br></pre></td></tr></table></figure>



<p>然后就可以访问了</p>
<p><a target="_blank" rel="noopener" href="https://10.12.52.66:30601/#/login">Kubernetes Dashboard</a></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914215807230.png" alt="image-20230914215807230"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230914215810665.png" alt="image-20230914215810665"></p>
<h2 id="部署deepflow"><a href="#部署deepflow" class="headerlink" title="部署deepflow"></a>部署deepflow</h2><p>官方文档</p>
<p><a target="_blank" rel="noopener" href="https://deepflow.io/docs/zh/install/all-in-one/">All-in-One 快速部署 | DeepFlow 文档</a></p>
<p>参考文档</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ljyfree/article/details/127547216">部署社区版deepflow_deepflow部署_ljyfree的博客-CSDN博客</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1<span class="comment"># helm repo add deepflow https://deepflowio.github.io/deepflow</span></span><br><span class="line"><span class="string">&quot;deepflow&quot;</span> has been added to your repositories</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">helm repo add deepflow https://deepflowio.github.io/deepflow</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; <span class="string">EOF &gt; values-custom.yaml</span></span><br><span class="line"><span class="string">global:</span></span><br><span class="line"><span class="string">  allInOneLocalStorage: true</span></span><br><span class="line"><span class="string">  image:</span></span><br><span class="line"><span class="string">      repository: registry.cn-beijing.aliyuncs.com/deepflow-ce</span></span><br><span class="line"><span class="string">grafana:</span></span><br><span class="line"><span class="string">  image:</span></span><br><span class="line"><span class="string">    repository: registry.cn-beijing.aliyuncs.com/deepflow-ce/grafana</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install deepflow -n deepflow deepflow/deepflow --create-namespace -f values-custom.yaml</span><br></pre></td></tr></table></figure>

<p>虚拟机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1<span class="comment"># helm install deepflow -n deepflow deepflow/deepflow --create-namespace -f values -custom.yaml</span></span><br><span class="line">NAME: deepflow</span><br><span class="line">LAST DEPLOYED: Sun Nov 26 06:39:31 2023</span><br><span class="line">NAMESPACE: deepflow</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">██████╗ ███████╗███████╗██████╗ ███████╗██╗      ██████╗ ██╗    ██╗</span><br><span class="line">██╔══██╗██╔════╝██╔════╝██╔══██╗██╔════╝██║     ██╔═══██╗██║    ██║</span><br><span class="line">██║  ██║█████╗  █████╗  ██████╔╝█████╗  ██║     ██║   ██║██║ █╗ ██║</span><br><span class="line">██║  ██║██╔══╝  ██╔══╝  ██╔═══╝ ██╔══╝  ██║     ██║   ██║██║███╗██║</span><br><span class="line">██████╔╝███████╗███████╗██║     ██║     ███████╗╚██████╔╝╚███╔███╔╝</span><br><span class="line">╚═════╝ ╚══════╝╚══════╝╚═╝     ╚═╝     ╚══════╝ ╚═════╝  ╚══╝╚══╝</span><br><span class="line"></span><br><span class="line">An automated observability platform <span class="keyword">for</span> cloud-native developers.</span><br><span class="line"></span><br><span class="line"><span class="comment"># deepflow-agent Port for receiving trace, metrics, and log</span></span><br><span class="line"></span><br><span class="line">deepflow-agent service: deepflow-agent.deepflow</span><br><span class="line">deepflow-agent Host listening port: 38086</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the Grafana URL to visit by running these commands in the same shell</span></span><br><span class="line"></span><br><span class="line">NODE_PORT=$(kubectl get --namespace deepflow -o jsonpath=<span class="string">&quot;&#123;.spec.ports[0].nodePort&#125;&quot;</span> services deepflow                                                            -grafana)</span><br><span class="line">NODE_IP=$(kubectl get nodes -o jsonpath=<span class="string">&quot;&#123;.items[0].status.addresses[0].address&#125;&quot;</span>)</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Grafana URL: http://<span class="variable">$NODE_IP</span>:<span class="variable">$NODE_PORT</span>  \nGrafana auth: admin:deepflow&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231126144719480.png" alt="image-20231126144719480"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231126144820100.png" alt="image-20231126144820100"></p>
<p>物理机：</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230916172856723.png" alt="image-20230916172856723"></p>
<p>安装 deepflow-ctl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#要科学上网，已经部署过了</span></span><br><span class="line">systemctl start clash </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -o /usr/bin/deepflow-ctl https://deepflow-ce.oss-cn-beijing.aliyuncs.com/bin/ctl/stable/linux/$(arch | sed <span class="string">&#x27;s|x86_64|amd64|&#x27;</span> | sed <span class="string">&#x27;s|aarch64|arm64|&#x27;</span>)/deepflow-ctl</span><br><span class="line">chmod a+x /usr/bin/deepflow-ctl</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行看看是否成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230918232612962.png" alt="image-20230918232612962"></p>
<p>这样就是成功了</p>
<p>这里server的pod一直没跑起来，查看日志后发现是clickhouse数据库的问题</p>
<p>输出日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs deepflow-server-66666d6d7f-psvq5 -n deepflw</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230917113851987.png" alt="image-20230917113851987"></p>
<p>但是clickhouse的pod是成功运行的</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230917113928662.png" alt="image-20230917113928662"></p>
<p>进入clickhouse容器内部看看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it deepflow-clickhouse-0 -n deepflow -- /bin/bash</span><br></pre></td></tr></table></figure>

<p> 检查存储目录的内容和权限</p>
<p>在 ClickHouse 容器内，检查 <code>/var/lib/clickhouse/</code> 和 <code>/var/lib/clickhouse_storage/</code> 的内容和权限。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -l /var/lib/clickhouse/</span><br><span class="line">ls -l /var/lib/clickhouse_storage/</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230917114113153.png" alt="image-20230917114113153"></p>
<p>确保文件和目录的所有权是 <code>clickhouse</code> 用户</p>
<p>查看 ClickHouse 日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/clickhouse-server/clickhouse-server.log</span><br></pre></td></tr></table></figure>

<p>检查 ClickHouse 数据库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it deepflow-clickhouse-0 -n deepflow -- /bin/bash</span><br></pre></td></tr></table></figure>

<p>在 ClickHouse 容器内，使用 ClickHouse CLI 来查询数据库。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> database</span><br></pre></td></tr></table></figure>

<p>这里没有截图，这里显示的database是没有flow_tag的，然后创建flow_tag</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE flow_tag;</span><br></pre></td></tr></table></figure>

<p>之后想解决MySQL的问题，搜索报错信息的时候，找到了这个一模一样的问题</p>
<p>[<a target="_blank" rel="noopener" href="https://github.com/deepflowio/deepflow/issues/3584">BUG] pod deepflow-server-XXX CrashLoopBackOff · Issue #3584 · deepflowio/deepflow (github.com)</a></p>
<p>Generally, mysql initialization fails due to poor disk performance or deepflow database table initialization fails. Try to log in mysql with root:deepflow to see if it can log in successfully. And add the following fields in the values - the custom files, update deepflow - server, if not successful landing, the empty mysql data directory/opt/deepflow/data/deepflow - mysql, Then add the following field to values-custom and update</p>
<blockquote>
<p>it.<br>一般是因为磁盘性能较差导致mysql初始化失败或者deepflow的数据库表初始化失败，使用 <code>root:deepflow</code> 尝试登陆 MySQL，看看是否能登陆成功，如果能登陆成功，则drop掉deepflow database，并在values-custom文件中添加如下字段，更新deepflow-server，如果不能成功登陆，则清空mysql数据目录 /opt/deepflow/data/deepflow-mysql，然后在values-custom中添加如下字段，并更新</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">readinessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">readinessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>这里参照这个方法尝试一下</p>
<p>先进入mysql的pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it deepflow-mysql-6c97f94d8f-rbgnl -n deepflow -- /bin/bash</span><br></pre></td></tr></table></figure>

<p>然后用<code>root:deepflow</code>连接一下数据库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -pdeepflow</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230917180155390.png" alt="image-20230917180155390"></p>
<p>然后把deepflow database drop掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE deepflow</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230917180215635.png" alt="image-20230917180215635"></p>
<p>然后退出，在values-custom文件中添加如下字段</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim values-custom</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">readinessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">readinessProbe:</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>然后重启server</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade deepflow -f values-custom.yaml -n deepflow deepflow/deepflow</span><br></pre></td></tr></table></figure>

<p>这里尝试了许多次，都失败了，找到了开发人员进行远程调试，他说他也用的同样的方法，但是我们重启server的方式有些许不同，可能就是这个原因吧，下面的图片是他的命令</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230918142925183.png" alt="image-20230918142925183"></p>
<p>我这里进行一下复刻</p>
<p>首先查看pod情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n deepflow</span><br></pre></td></tr></table></figure>

<p>接着看看server的情况，以yaml文件形式输出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod deepflow-server-67d9688bdc-tnpsb -n deepflow -o yaml</span><br></pre></td></tr></table></figure>

<p>查看之后，发现是同样的问题，就先将server的pod给停掉</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deploy -n deepflow deepflow-server --replicas=0</span><br></pre></td></tr></table></figure>

<p>然后进入mysql的pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it deepflow-mysql-6c97f94d8f-rbgnl -n deepflow -- /bin/bash</span><br></pre></td></tr></table></figure>

<p>然后也是drop掉deepflow的database</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE deepflow</span><br></pre></td></tr></table></figure>

<p>然后退出重启server</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deploy -n deepflow deepflow-server --replicas=1</span><br></pre></td></tr></table></figure>

<p>然后就是漫长的等待</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n deepflow deepflow-server-67d9688bdc-tnpsb -f</span><br></pre></td></tr></table></figure>

<p>然后就好了</p>
<h2 id="删除deepflow"><a href="#删除deepflow" class="headerlink" title="删除deepflow"></a>删除deepflow</h2><ol>
<li><p>使用 <code>helm list</code> 查看当前 Helm releases：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list -n deepflow</span><br></pre></td></tr></table></figure></li>
<li><p>确认你看到名为 <code>deepflow</code> 的 release 在上述 namespace (<code>deepflow</code>) 中。</p>
</li>
<li><p>使用 <code>helm uninstall</code> 来删除这个 release：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall deepflow -n deepflow</span><br></pre></td></tr></table></figure></li>
<li><p>删除 <code>deepflow</code> namespace</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete namespace deepflow</span><br></pre></td></tr></table></figure>

<p><strong>查看命名空间中的所有资源</strong>：</p>
<p>使用以下命令可以列出命名空间中的所有资源：</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n deepflow</span><br></pre></td></tr></table></figure>

<p><strong>手动删除残留资源</strong>：</p>
<p>根据上述命令的输出，手动删除命名空间中的任何残留资源。例如，如果你发现有一个未删除的 ConfigMap，可以使用以下命令删除它：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete configmap &lt;configmap-name&gt; -n &lt;your-namespace-name&gt;</span><br></pre></td></tr></table></figure>

<p><strong>删除命名空间的终结器</strong>：</p>
<p>如果在清理所有资源后命名空间仍然没有被删除，可能是因为命名空间对象上的终结器阻止了它。要删除它，你需要编辑命名空间并删除 <code>finalizers</code>。</p>
<p>使用以下命令编辑命名空间：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get namespace deepflow -o json | jq <span class="string">&#x27;.spec.finalizers=[]&#x27;</span> | kubectl replace --raw <span class="string">&quot;/api/v1/namespaces/deepflow/finalize&quot;</span> -f -</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>手动删除处于 <code>Terminating</code> 状态的 Pods</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-agent-w6nzw</span><br><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-app-7f69b47dd6-nk928</span><br><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-clickhouse-0</span><br><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-grafana-84cdcdf594-8f7sg</span><br><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-mysql-6fc8c8cf85-f78sp</span><br><span class="line">kubectl delete pod -n deepflow --force --grace-period=0 deepflow-server-bb9699c94-tcgcx</span><br></pre></td></tr></table></figure>



<h1 id="学习网站在这"><a href="#学习网站在这" class="headerlink" title="学习网站在这"></a>学习网站在这</h1><h2 id="ebpf官网"><a href="#ebpf官网" class="headerlink" title="ebpf官网"></a>ebpf官网</h2><p><a target="_blank" rel="noopener" href="https://ebpf.io/applications/">eBPF Applications Landscape</a></p>
<h2 id="ebpf入门实战"><a href="#ebpf入门实战" class="headerlink" title="ebpf入门实战"></a>ebpf入门实战</h2><p><a target="_blank" rel="noopener" href="https://www.zadmei.com/ehxjsysz.html">https://www.zadmei.com/ehxjsysz.html</a></p>
<h2 id="基于-eBPF-的高度自动化可观测性实践"><a href="#基于-eBPF-的高度自动化可观测性实践" class="headerlink" title="基于 eBPF 的高度自动化可观测性实践"></a>基于 eBPF 的高度自动化可观测性实践</h2><p><a target="_blank" rel="noopener" href="https://deepflow.io/blog/zh/018-the-practice-of-automatically-implementing-observability-based-on-ebpf/">DeepFlow 基于 eBPF 的高度自动化可观测性实践 - DeepFlow</a></p>
<h2 id="deepflow高级配置"><a href="#deepflow高级配置" class="headerlink" title="deepflow高级配置"></a>deepflow高级配置</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><a target="_blank" rel="noopener" href="https://deepflow.io/docs/zh/install/advanced-config/server-advanced-config/">Server 高级配置 | DeepFlow 文档</a></p>
<h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><p><a target="_blank" rel="noopener" href="https://deepflow.io/docs/zh/install/advanced-config/agent-advanced-config/">Agent 高级配置 | DeepFlow 文档</a></p>
<h2 id="Linux性能优化实战"><a href="#Linux性能优化实战" class="headerlink" title="Linux性能优化实战"></a>Linux性能优化实战</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fiab13/p/14394274.html">Linux性能优化实战学习笔记（转载目录） - fiab13 - 博客园 (cnblogs.com)</a></p>
<h2 id="ebpf学习"><a href="#ebpf学习" class="headerlink" title="ebpf学习"></a>ebpf学习</h2><h3 id="ebpf深入浅出"><a href="#ebpf深入浅出" class="headerlink" title="ebpf深入浅出"></a>ebpf深入浅出</h3><p><a target="_blank" rel="noopener" href="https://www.ebpf.top/post/ebpf_c_env/">【BPF入门系列-3】BPF 环境搭建 | 深入浅出 eBPF</a></p>
<h3 id="eBPF-核心技术与实战"><a href="#eBPF-核心技术与实战" class="headerlink" title="eBPF 核心技术与实战"></a>eBPF 核心技术与实战</h3><p><a target="_blank" rel="noopener" href="https://www.zadmei.com/ehxjsysz.html">https://www.zadmei.com/ehxjsysz.html</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-192452-id-5862626.html">ubuntu 20.04安装libbpf-mfc42d-ChinaUnix博客</a></p>
<h2 id="搭建eBPF开发环境（在他给的docker容器里实际上是不需要搭建的）"><a href="#搭建eBPF开发环境（在他给的docker容器里实际上是不需要搭建的）" class="headerlink" title="搭建eBPF开发环境（在他给的docker容器里实际上是不需要搭建的）"></a>搭建eBPF开发环境（在他给的docker容器里实际上是不需要搭建的）</h2><h3 id="注：从下面开始，到分割线的所有内容均可不做参考"><a href="#注：从下面开始，到分割线的所有内容均可不做参考" class="headerlink" title="注：从下面开始，到分割线的所有内容均可不做参考"></a>注：从下面开始，到分割线的所有内容均可不做参考</h3><p>参考文档：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/JoshuaYu/p/15086912.html">Ubuntu安装BCC - 骇人的籽 - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43472789/article/details/130839929">Ubuntu 安装 libbpf 教程_Chientol的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43966076/article/details/132618984">ubuntu20.04安装bcc_JD怕秃头的博客-CSDN博客</a></p>
<p>主要参照的是第一个链接</p>
<p>其中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@mobb-iMac:/home/mobb/bcc/build<span class="comment"># sudo apt-get -y install bison build-essential cmake flex git libedit-dev \</span></span><br><span class="line">&gt;   libllvm3.7 llvm-3.7-dev libclang-3.7-dev python zlib1g-dev libelf-dev</span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树</span><br><span class="line">正在读取状态信息... 完成</span><br><span class="line">注意，选中 <span class="string">&#x27;python-is-python2&#x27;</span> 而非 <span class="string">&#x27;python&#x27;</span></span><br><span class="line">E: 无法定位软件包 libllvm3.7</span><br><span class="line">E: 无法按照 glob ‘libllvm3.7’ 找到任何软件包</span><br><span class="line">E: 无法按照正则表达式 libllvm3.7 找到任何软件包</span><br><span class="line">E: 无法定位软件包 llvm-3.7-dev</span><br><span class="line">E: 无法按照 glob ‘llvm-3.7-dev’ 找到任何软件包</span><br><span class="line">E: 无法按照正则表达式 llvm-3.7-dev 找到任何软件包</span><br><span class="line">E: 无法定位软件包 libclang-3.7-dev</span><br><span class="line">E: 无法按照 glob ‘libclang-3.7-dev’ 找到任何软件包</span><br><span class="line">E: 无法按照正则表达式 libclang-3.7-dev 找到任何软件包</span><br><span class="line"></span><br><span class="line"><span class="comment">#这个步骤需要更改为</span></span><br><span class="line">sudo apt-get -y install bison build-essential cmake flex git libedit-dev \</span><br><span class="line">llvm-dev libclang-dev python zlib1g-dev libelf-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2023.10.04参照了另一个博客，这个是我在进行源码编译运行时遇到了许多问题，最后不知道怎么的来到了这里</p>
<p>[Ubuntu 18.04 LTS源码构建bcc_ubuntu 18.04 安装 ebpf-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44395686/article/details/106712543#:~:text=%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85bcc">https://blog.csdn.net/weixin_44395686/article/details/106712543#:~:text=源码编译安装bcc</a> 1 检查环境 (特别高版本内核可以忽略此步) 内核配置 ：高版本的内核这些是标配，基本不用管，不放心也可以检查下。 通过命令 less,libclang-6.0-dev python zlib1g-dev libelf-dev 1 2 除了官网要求的这些工具之外，还要额外安装几个python3的包 )</p>
<p>参照第二个博客的时候在安装clang时就发生了报错</p>
<p>有一些软件包无法被安装。如果您用的是 unstable 发行版，这也许是<br>因为系统无法达到您要求的状态造成的。该版本中可能会有一些您需要的软件<br>包尚未被创建或是它们已被从新到(Incoming)目录移出。<br>下列信息可能会对解决问题有所帮助：<br>下列软件包有未满足的依赖关系：<br>fcitx : 依赖: fcitx-data 但是它将不会被安装<br>E: 无法修正错误，因为您要求某些软件包保持现状，就是它们破坏了软件包间的依赖关系。</p>
<p>找了很久最终在这里找到了解决办法</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33406883/article/details/100971183">https://blog.csdn.net/qq_33406883/article/details/100971183</a></p>
<p>最后记得要重启一下</p>
<p>然后再次运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230925175835177.png" alt="image-20230925175835177"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># clang -v</span></span><br><span class="line">clang version 10.0.0-4ubuntu1</span><br><span class="line">Target: x86_64-pc-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">InstalledDir: /usr/bin</span><br><span class="line">Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/9</span><br><span class="line">Found candidate GCC installation: /usr/lib/gcc/x86_64-linux-gnu/9</span><br><span class="line">Selected GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/9</span><br><span class="line">Candidate multilib: .;@m64</span><br><span class="line">Candidate multilib: 32;@m32</span><br><span class="line">Candidate multilib: x32;@mx32</span><br><span class="line">Selected multilib: .;@m64</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>依次安装下面这些依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install llvm</span><br><span class="line">sudo apt install pkg-config</span><br><span class="line">sudo apt install m4</span><br><span class="line">sudo apt install libelf-dev</span><br><span class="line">sudo apt install libpcap-dev</span><br></pre></td></tr></table></figure>

<p>全部安装成功后，将二进制安装包clone下来并解压</p>
<p>然后进入解压目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> src</span><br><span class="line"></span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb/libbpf-1.2.2/src<span class="comment"># make</span></span><br><span class="line">  MKDIR    staticobjs</span><br><span class="line">  CC       staticobjs/bpf.o</span><br><span class="line">  CC       staticobjs/btf.o</span><br><span class="line">  CC       staticobjs/libbpf.o</span><br><span class="line">  CC       staticobjs/libbpf_errno.o</span><br><span class="line">  CC       staticobjs/netlink.o</span><br><span class="line">  CC       staticobjs/nlattr.o</span><br><span class="line">  CC       staticobjs/str_error.o</span><br><span class="line">  CC       staticobjs/libbpf_probes.o</span><br><span class="line">  CC       staticobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       staticobjs/btf_dump.o</span><br><span class="line">  CC       staticobjs/hashmap.o</span><br><span class="line">  CC       staticobjs/ringbuf.o</span><br><span class="line">  CC       staticobjs/strset.o</span><br><span class="line">  CC       staticobjs/linker.o</span><br><span class="line">  CC       staticobjs/gen_loader.o</span><br><span class="line">  CC       staticobjs/relo_core.o</span><br><span class="line">  CC       staticobjs/usdt.o</span><br><span class="line">  CC       staticobjs/zip.o</span><br><span class="line">  AR       libbpf.a</span><br><span class="line">  MKDIR    sharedobjs</span><br><span class="line">  CC       sharedobjs/bpf.o</span><br><span class="line">  CC       sharedobjs/btf.o</span><br><span class="line">  CC       sharedobjs/libbpf.o</span><br><span class="line">  CC       sharedobjs/libbpf_errno.o</span><br><span class="line">  CC       sharedobjs/netlink.o</span><br><span class="line">  CC       sharedobjs/nlattr.o</span><br><span class="line">  CC       sharedobjs/str_error.o</span><br><span class="line">  CC       sharedobjs/libbpf_probes.o</span><br><span class="line">  CC       sharedobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       sharedobjs/btf_dump.o</span><br><span class="line">  CC       sharedobjs/hashmap.o</span><br><span class="line">  CC       sharedobjs/ringbuf.o</span><br><span class="line">  CC       sharedobjs/strset.o</span><br><span class="line">  CC       sharedobjs/linker.o</span><br><span class="line">  CC       sharedobjs/gen_loader.o</span><br><span class="line">  CC       sharedobjs/relo_core.o</span><br><span class="line">  CC       sharedobjs/usdt.o</span><br><span class="line">  CC       sharedobjs/zip.o</span><br><span class="line">  CC       libbpf.so.1.2.2</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>虽然这里安装成功了，但是跑代码的时候还是报错，再次尝试了一下这个命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb<span class="comment"># sudo apt-get install -y make clang llvm libelf-dev libbpf-dev bpfcc-tools libbpfcc-dev linux-tools-$(uname -r) linux-headers-$(uname -r)</span></span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树</span><br><span class="line">正在读取状态信息... 完成</span><br><span class="line">make 已经是最新版 (4.2.1-1.2)。</span><br><span class="line">make 已设置为手动安装。</span><br><span class="line">linux-headers-5.15.0-79-generic 已经是最新版 (5.15.0-79.86~20.04.2)。</span><br><span class="line">linux-headers-5.15.0-79-generic 已设置为手动安装。</span><br><span class="line">下列软件包是自动安装的并且现在不需要了：</span><br><span class="line">  libcbor0.6 libfido2-1</span><br><span class="line">使用<span class="string">&#x27;sudo apt autoremove&#x27;</span>来卸载它(它们)。</span><br><span class="line">将会同时安装下列软件：</span><br><span class="line">  binfmt-support clang-10 ieee-data lib32gcc-s1 lib32stdc++6 libbpf0 libbpfcc libc6-i386</span><br><span class="line">  libclang-common-10-dev libclang-cpp10 libclang1-10 libdw1 libelf1 libelf1:i386</span><br><span class="line">  libllvm10 libncurses-dev libobjc-9-dev libobjc4 libomp-10-dev libomp5-10 libpfm4</span><br><span class="line">  libtinfo-dev libz3-4 libz3-dev linux-hwe-5.15-tools-5.15.0-79 linux-tools-common</span><br><span class="line">  llvm-10 llvm-10-dev llvm-10-runtime llvm-10-tools llvm-runtime python3-bpfcc</span><br><span class="line">  python3-netaddr python3-pygments</span><br><span class="line">建议安装：</span><br><span class="line">  clang-10-doc ncurses-doc libomp-10-doc llvm-10-doc ipython3 python-netaddr-docs</span><br><span class="line">  python-pygments-doc ttf-bitstream-vera</span><br><span class="line">下列【新】软件包将被安装：</span><br><span class="line">  binfmt-support bpfcc-tools clang clang-10 ieee-data lib32gcc-s1 lib32stdc++6 libbpf-dev</span><br><span class="line">  libbpf0 libbpfcc libbpfcc-dev libc6-i386 libclang-common-10-dev libclang-cpp10</span><br><span class="line">  libclang1-10 libelf-dev libllvm10 libncurses-dev libobjc-9-dev libobjc4 libomp-10-dev</span><br><span class="line">  libomp5-10 libpfm4 libtinfo-dev libz3-4 libz3-dev linux-hwe-5.15-tools-5.15.0-79</span><br><span class="line">  linux-tools-5.15.0-79-generic linux-tools-common llvm llvm-10 llvm-10-dev</span><br><span class="line">  llvm-10-runtime llvm-10-tools llvm-runtime python3-bpfcc python3-netaddr</span><br><span class="line">  python3-pygments</span><br><span class="line">下列软件包将被升级：</span><br><span class="line">  libdw1 libelf1 libelf1:i386</span><br><span class="line">升级了 3 个软件包，新安装了 38 个软件包，要卸载 0 个软件包，有 156 个软件包未被升级。</span><br><span class="line">需要下载 107 MB/107 MB 的归档。</span><br><span class="line">解压缩后会消耗 602 MB 的额外空间。</span><br><span class="line">获取:1 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 binfmt-support amd64 2.2.0-2 [58.2 kB]</span><br><span class="line">获取:2 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libbpfcc amd64 0.12.0-2 [14.9 MB]</span><br><span class="line">获取:7 http://security.ubuntu.com/ubuntu focal-security/universe amd64 libobjc4 amd64 10.5.0-1ubuntu1~20.04 [42.8 kB]</span><br><span class="line">获取:29 http://security.ubuntu.com/ubuntu focal-security/universe amd64 libobjc-9-dev amd64 9.4.0-1ubuntu1~20.04.2 [225 kB]</span><br><span class="line">获取:3 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 python3-bpfcc all 0.12.0-2 [31.3 kB]</span><br><span class="line">获取:4 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 ieee-data all 20180805.1 [1,589 kB]</span><br><span class="line">获取:5 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/main amd64 python3-netaddr all 0.7.19-3ubuntu1 [236 kB]</span><br><span class="line">获取:6 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 bpfcc-tools all 0.12.0-2 [579 kB]</span><br><span class="line">获取:8 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 libllvm10 amd64 1:10.0.0-4ubuntu1 [15.3 MB]</span><br><span class="line">获取:30 http://security.ubuntu.com/ubuntu focal-security/main amd64 lib32gcc-s1 amd64 10.5.0-1ubuntu1~20.04 [49.1 kB]</span><br><span class="line">获取:31 http://security.ubuntu.com/ubuntu focal-security/main amd64 lib32stdc++6 amd64 10.5.0-1ubuntu1~20.04 [522 kB]</span><br><span class="line">获取:9 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang-cpp10 amd64 1:10.0.0-4ubuntu1 [9,944 kB]</span><br><span class="line">获取:32 http://security.ubuntu.com/ubuntu focal-security/main amd64 libelf-dev amd64 0.176-1.1ubuntu0.1 [57.1 kB]</span><br><span class="line">获取:33 http://security.ubuntu.com/ubuntu focal-security/main amd64 libncurses-dev amd64 6.2-0ubuntu2.1 [340 kB]</span><br><span class="line">获取:10 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/main amd64 libc6-i386 amd64 2.31-0ubuntu9.9 [2,730 kB]</span><br><span class="line">获取:11 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang-common-10-dev amd64 1:10.0.0-4ubuntu1 [5,012 kB]</span><br><span class="line">获取:34 http://security.ubuntu.com/ubuntu focal-security/main amd64 libtinfo-dev amd64 6.2-0ubuntu2.1 [972 B]</span><br><span class="line">获取:35 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-tools-common all 5.4.0-163.180 [197 kB]</span><br><span class="line">获取:12 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang1-10 amd64 1:10.0.0-4ubuntu1 [7,571 kB]</span><br><span class="line">获取:36 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-hwe-5.15-tools-5.15.0-79 amd64 5.15.0-79.86~20.04.2 [7,296 kB]</span><br><span class="line">获取:13 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 clang-10 amd64 1:10.0.0-4ubuntu1 [66.9 kB]</span><br><span class="line">获取:14 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 clang amd64 1:10.0-50~exp1 [3,276 B]</span><br><span class="line">获取:15 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/universe amd64 libbpf0 amd64 1:0.5.0-1~ubuntu20.04.1 [128 kB]</span><br><span class="line">获取:16 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/universe amd64 libbpf-dev amd64 1:0.5.0-1~ubuntu20.04.1 [188 kB]</span><br><span class="line">获取:17 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libbpfcc-dev amd64 0.12.0-2 [16.4 kB]</span><br><span class="line">获取:18 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libomp5-10 amd64 1:10.0.0-4ubuntu1 [300 kB]</span><br><span class="line">获取:19 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libomp-10-dev amd64 1:10.0.0-4ubuntu1 [47.7 kB]</span><br><span class="line">获取:20 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-runtime amd64 1:10.0.0-4ubuntu1 [180 kB]</span><br><span class="line">获取:21 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-runtime amd64 1:10.0-50~exp1 [2,916 B]</span><br><span class="line">获取:22 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 libpfm4 amd64 4.10.1+git20-g7700f49-2 [266 kB]</span><br><span class="line">获取:23 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10 amd64 1:10.0.0-4ubuntu1 [5,214 kB]</span><br><span class="line">获取:24 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm amd64 1:10.0-50~exp1 [3,880 B]</span><br><span class="line">获取:25 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-tools amd64 1:10.0.0-4ubuntu1 [317 kB]</span><br><span class="line">获取:26 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libz3-4 amd64 4.8.7-4build1 [6,792 kB]</span><br><span class="line">获取:27 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libz3-dev amd64 4.8.7-4build1 [67.5 kB]</span><br><span class="line">获取:28 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-dev amd64 1:10.0.0-4ubuntu1 [26.0 MB]</span><br><span class="line">获取:37 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-tools-5.15.0-79-generic amd64 5.15.0-79.86~20.04.2 [2,008 B]</span><br><span class="line">获取:38 http://security.ubuntu.com/ubuntu focal-security/main amd64 python3-pygments all 2.3.1+dfsg-1ubuntu2.2 [579 kB]</span><br><span class="line">已下载 107 MB，耗时 14秒 (7,800 kB/s)</span><br><span class="line">正在从软件包中解出模板：100%</span><br><span class="line">(正在读取数据库 ... 系统当前共安装有 208477 个文件和目录。)</span><br><span class="line">准备解压 .../00-libdw1_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libdw1:amd64 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">准备解压 .../01-libelf1_0.176-1.1ubuntu0.1_i386.deb  ...</span><br><span class="line">正在反配置 libelf1:amd64 (0.176-1.1build1) ...</span><br><span class="line">正在解压 libelf1:i386 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">准备解压 .../02-libelf1_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libelf1:amd64 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">正在选中未选择的软件包 binfmt-support。</span><br><span class="line">准备解压 .../03-binfmt-support_2.2.0-2_amd64.deb  ...</span><br><span class="line">正在解压 binfmt-support (2.2.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libbpfcc。</span><br><span class="line">准备解压 .../04-libbpfcc_0.12.0-2_amd64.deb  ...</span><br><span class="line">正在解压 libbpfcc (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 python3-bpfcc。</span><br><span class="line">准备解压 .../05-python3-bpfcc_0.12.0-2_all.deb  ...</span><br><span class="line">正在解压 python3-bpfcc (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 ieee-data。</span><br><span class="line">准备解压 .../06-ieee-data_20180805.1_all.deb  ...</span><br><span class="line">正在解压 ieee-data (20180805.1) ...</span><br><span class="line">正在选中未选择的软件包 python3-netaddr。</span><br><span class="line">准备解压 .../07-python3-netaddr_0.7.19-3ubuntu1_all.deb  ...</span><br><span class="line">正在解压 python3-netaddr (0.7.19-3ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 bpfcc-tools。</span><br><span class="line">准备解压 .../08-bpfcc-tools_0.12.0-2_all.deb  ...</span><br><span class="line">正在解压 bpfcc-tools (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libllvm10:amd64。</span><br><span class="line">准备解压 .../09-libllvm10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libllvm10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libclang-cpp10。</span><br><span class="line">准备解压 .../10-libclang-cpp10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang-cpp10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libobjc4:amd64。</span><br><span class="line">准备解压 .../11-libobjc4_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 libobjc4:amd64 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 libobjc-9-dev:amd64。</span><br><span class="line">准备解压 .../12-libobjc-9-dev_9.4.0-1ubuntu1~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 libobjc-9-dev:amd64 (9.4.0-1ubuntu1~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 libc6-i386。</span><br><span class="line">准备解压 .../13-libc6-i386_2.31-0ubuntu9.9_amd64.deb  ...</span><br><span class="line">正在解压 libc6-i386 (2.31-0ubuntu9.9) ...</span><br><span class="line">被已安装的软件包 libc6:i386 (2.31-0ubuntu9.9) 中的文件替换了...</span><br><span class="line">正在选中未选择的软件包 lib32gcc-s1。</span><br><span class="line">准备解压 .../14-lib32gcc-s1_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 lib32gcc-s1 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 lib32stdc++6。</span><br><span class="line">准备解压 .../15-lib32stdc++6_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 lib32stdc++6 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 libclang-common-10-dev。</span><br><span class="line">准备解压 .../16-libclang-common-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang-common-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libclang1-10。</span><br><span class="line">准备解压 .../17-libclang1-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang1-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 clang-10。</span><br><span class="line">准备解压 .../18-clang-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 clang-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 clang。</span><br><span class="line">准备解压 .../19-clang_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 clang (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 libbpf0:amd64。</span><br><span class="line">准备解压 .../20-libbpf0_1%3a0.5.0-1~ubuntu20.04.1_amd64.deb  ...</span><br><span class="line">正在解压 libbpf0:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在选中未选择的软件包 libelf-dev:amd64。</span><br><span class="line">准备解压 .../21-libelf-dev_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libelf-dev:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在选中未选择的软件包 libbpf-dev:amd64。</span><br><span class="line">准备解压 .../22-libbpf-dev_1%3a0.5.0-1~ubuntu20.04.1_amd64.deb  ...</span><br><span class="line">正在解压 libbpf-dev:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在选中未选择的软件包 libbpfcc-dev。</span><br><span class="line">准备解压 .../23-libbpfcc-dev_0.12.0-2_amd64.deb  ...</span><br><span class="line">正在解压 libbpfcc-dev (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libncurses-dev:amd64。</span><br><span class="line">准备解压 .../24-libncurses-dev_6.2-0ubuntu2.1_amd64.deb  ...</span><br><span class="line">正在解压 libncurses-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在选中未选择的软件包 libomp5-10:amd64。</span><br><span class="line">准备解压 .../25-libomp5-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libomp5-10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libomp-10-dev。</span><br><span class="line">准备解压 .../26-libomp-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libomp-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libtinfo-dev:amd64。</span><br><span class="line">准备解压 .../27-libtinfo-dev_6.2-0ubuntu2.1_amd64.deb  ...</span><br><span class="line">正在解压 libtinfo-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在选中未选择的软件包 linux-tools-common。</span><br><span class="line">准备解压 .../28-linux-tools-common_5.4.0-163.180_all.deb  ...</span><br><span class="line">正在解压 linux-tools-common (5.4.0-163.180) ...</span><br><span class="line">正在选中未选择的软件包 linux-hwe-5.15-tools-5.15.0-79。</span><br><span class="line">准备解压 .../29-linux-hwe-5.15-tools-5.15.0-79_5.15.0-79.86~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 linux-hwe-5.15-tools-5.15.0-79 (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 linux-tools-5.15.0-79-generic。</span><br><span class="line">准备解压 .../30-linux-tools-5.15.0-79-generic_5.15.0-79.86~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 linux-tools-5.15.0-79-generic (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-runtime。</span><br><span class="line">准备解压 .../31-llvm-10-runtime_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-runtime (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 llvm-runtime。</span><br><span class="line">准备解压 .../32-llvm-runtime_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-runtime (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 libpfm4:amd64。</span><br><span class="line">准备解压 .../33-libpfm4_4.10.1+git20-g7700f49-2_amd64.deb  ...</span><br><span class="line">正在解压 libpfm4:amd64 (4.10.1+git20-g7700f49-2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10。</span><br><span class="line">准备解压 .../34-llvm-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 llvm。</span><br><span class="line">准备解压 .../35-llvm_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 llvm (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 python3-pygments。</span><br><span class="line">准备解压 .../36-python3-pygments_2.3.1+dfsg-1ubuntu2.2_all.deb  ...</span><br><span class="line">正在解压 python3-pygments (2.3.1+dfsg-1ubuntu2.2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-tools。</span><br><span class="line">准备解压 .../37-llvm-10-tools_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-tools (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libz3-4:amd64。</span><br><span class="line">准备解压 .../38-libz3-4_4.8.7-4build1_amd64.deb  ...</span><br><span class="line">正在解压 libz3-4:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在选中未选择的软件包 libz3-dev:amd64。</span><br><span class="line">准备解压 .../39-libz3-dev_4.8.7-4build1_amd64.deb  ...</span><br><span class="line">正在解压 libz3-dev:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-dev。</span><br><span class="line">准备解压 .../40-llvm-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libncurses-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在设置 libobjc4:amd64 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 libllvm10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 python3-pygments (2.3.1+dfsg-1ubuntu2.2) ...</span><br><span class="line">正在设置 libz3-4:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在设置 libpfm4:amd64 (4.10.1+git20-g7700f49-2) ...</span><br><span class="line">正在设置 libclang1-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 binfmt-support (2.2.0-2) ...</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/binfmt-support.service → /lib/systemd/system/binfmt-support.service.</span><br><span class="line">正在设置 libobjc-9-dev:amd64 (9.4.0-1ubuntu1~20.04.2) ...</span><br><span class="line">正在设置 ieee-data (20180805.1) ...</span><br><span class="line">正在设置 libomp5-10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libc6-i386 (2.31-0ubuntu9.9) ...</span><br><span class="line">正在设置 libelf1:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 libelf1:i386 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 linux-tools-common (5.4.0-163.180) ...</span><br><span class="line">正在设置 libtinfo-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在设置 libz3-dev:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在设置 libdw1:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 llvm-10-tools (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libomp-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libclang-cpp10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 llvm-10-runtime (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 lib32gcc-s1 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 lib32stdc++6 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 llvm-runtime (1:10.0-50~exp1) ...</span><br><span class="line">正在设置 libelf-dev:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 python3-netaddr (0.7.19-3ubuntu1) ...</span><br><span class="line">正在设置 libbpf0:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在设置 libbpfcc (0.12.0-2) ...</span><br><span class="line">正在设置 python3-bpfcc (0.12.0-2) ...</span><br><span class="line">正在设置 linux-hwe-5.15-tools-5.15.0-79 (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在设置 libbpf-dev:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在设置 libclang-common-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 linux-tools-5.15.0-79-generic (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在设置 llvm-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 llvm-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 bpfcc-tools (0.12.0-2) ...</span><br><span class="line">正在设置 libbpfcc-dev (0.12.0-2) ...</span><br><span class="line">正在设置 llvm (1:10.0-50~exp1) ...</span><br><span class="line">正在设置 clang-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 clang (1:10.0-50~exp1) ...</span><br><span class="line">正在处理用于 systemd (245.4-4ubuntu3.20) 的触发器 ...</span><br><span class="line">正在处理用于 man-db (2.9.1-1) 的触发器 ...</span><br><span class="line">正在处理用于 libc-bin (2.31-0ubuntu9.9) 的触发器 ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看文件是否已安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> cat /boot/config-5.15.0-79-generic |grep BPF</span><br><span class="line">CONFIG_BPF=y</span><br><span class="line">CONFIG_HAVE_EBPF_JIT=y</span><br><span class="line">CONFIG_ARCH_WANT_DEFAULT_BPF_JIT=y</span><br><span class="line"><span class="comment"># BPF subsystem</span></span><br><span class="line">CONFIG_BPF_SYSCALL=y</span><br><span class="line">CONFIG_BPF_JIT=y</span><br><span class="line">CONFIG_BPF_JIT_ALWAYS_ON=y</span><br><span class="line">CONFIG_BPF_JIT_DEFAULT_ON=y</span><br><span class="line">CONFIG_BPF_UNPRIV_DEFAULT_OFF=y</span><br><span class="line"><span class="comment"># CONFIG_BPF_PRELOAD is not set</span></span><br><span class="line">CONFIG_BPF_LSM=y</span><br><span class="line"><span class="comment"># end of BPF subsystem</span></span><br><span class="line">CONFIG_CGROUP_BPF=y</span><br><span class="line">CONFIG_IPV6_SEG6_BPF=y</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_BPF=m</span><br><span class="line">CONFIG_BPFILTER=y</span><br><span class="line">CONFIG_BPFILTER_UMH=m</span><br><span class="line">CONFIG_NET_CLS_BPF=m</span><br><span class="line">CONFIG_NET_ACT_BPF=m</span><br><span class="line">CONFIG_BPF_STREAM_PARSER=y</span><br><span class="line">CONFIG_LWTUNNEL_BPF=y</span><br><span class="line">CONFIG_BPF_EVENTS=y</span><br><span class="line">CONFIG_BPF_KPROBE_OVERRIDE=y</span><br><span class="line">CONFIG_TEST_BPF=m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里也有显示了，但是不知道为什么还是没能运行，报了这样的错</p>
<p><a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/issues/2278">ImportError: cannot import name BPF · Issue #2278 · iovisor/bcc (github.com)</a></p>
<p>最后重新再安装了一遍</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb<span class="comment"># sudo apt-get install -y make clang llvm libelf-dev libbpf-dev bpfcc-tools libbpfcc-dev linux-tools-$(uname -r) linux-headers-$(uname -r)</span></span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树</span><br><span class="line">正在读取状态信息... 完成</span><br><span class="line">make 已经是最新版 (4.2.1-1.2)。</span><br><span class="line">make 已设置为手动安装。</span><br><span class="line">linux-headers-5.15.0-79-generic 已经是最新版 (5.15.0-79.86~20.04.2)。</span><br><span class="line">linux-headers-5.15.0-79-generic 已设置为手动安装。</span><br><span class="line">下列软件包是自动安装的并且现在不需要了：</span><br><span class="line">  libcbor0.6 libfido2-1</span><br><span class="line">使用<span class="string">&#x27;sudo apt autoremove&#x27;</span>来卸载它(它们)。</span><br><span class="line">将会同时安装下列软件：</span><br><span class="line">  binfmt-support clang-10 ieee-data lib32gcc-s1 lib32stdc++6 libbpf0 libbpfcc libc6-i386</span><br><span class="line">  libclang-common-10-dev libclang-cpp10 libclang1-10 libdw1 libelf1 libelf1:i386</span><br><span class="line">  libllvm10 libncurses-dev libobjc-9-dev libobjc4 libomp-10-dev libomp5-10 libpfm4</span><br><span class="line">  libtinfo-dev libz3-4 libz3-dev linux-hwe-5.15-tools-5.15.0-79 linux-tools-common</span><br><span class="line">  llvm-10 llvm-10-dev llvm-10-runtime llvm-10-tools llvm-runtime python3-bpfcc</span><br><span class="line">  python3-netaddr python3-pygments</span><br><span class="line">建议安装：</span><br><span class="line">  clang-10-doc ncurses-doc libomp-10-doc llvm-10-doc ipython3 python-netaddr-docs</span><br><span class="line">  python-pygments-doc ttf-bitstream-vera</span><br><span class="line">下列【新】软件包将被安装：</span><br><span class="line">  binfmt-support bpfcc-tools clang clang-10 ieee-data lib32gcc-s1 lib32stdc++6 libbpf-dev</span><br><span class="line">  libbpf0 libbpfcc libbpfcc-dev libc6-i386 libclang-common-10-dev libclang-cpp10</span><br><span class="line">  libclang1-10 libelf-dev libllvm10 libncurses-dev libobjc-9-dev libobjc4 libomp-10-dev</span><br><span class="line">  libomp5-10 libpfm4 libtinfo-dev libz3-4 libz3-dev linux-hwe-5.15-tools-5.15.0-79</span><br><span class="line">  linux-tools-5.15.0-79-generic linux-tools-common llvm llvm-10 llvm-10-dev</span><br><span class="line">  llvm-10-runtime llvm-10-tools llvm-runtime python3-bpfcc python3-netaddr</span><br><span class="line">  python3-pygments</span><br><span class="line">下列软件包将被升级：</span><br><span class="line">  libdw1 libelf1 libelf1:i386</span><br><span class="line">升级了 3 个软件包，新安装了 38 个软件包，要卸载 0 个软件包，有 156 个软件包未被升级。</span><br><span class="line">需要下载 107 MB/107 MB 的归档。</span><br><span class="line">解压缩后会消耗 602 MB 的额外空间。</span><br><span class="line">获取:1 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 binfmt-support amd64 2.2.0-2 [58.2 kB]</span><br><span class="line">获取:2 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libbpfcc amd64 0.12.0-2 [14.9 MB]</span><br><span class="line">获取:7 http://security.ubuntu.com/ubuntu focal-security/universe amd64 libobjc4 amd64 10.5.0-1ubuntu1~20.04 [42.8 kB]</span><br><span class="line">获取:29 http://security.ubuntu.com/ubuntu focal-security/universe amd64 libobjc-9-dev amd64 9.4.0-1ubuntu1~20.04.2 [225 kB]</span><br><span class="line">获取:3 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 python3-bpfcc all 0.12.0-2 [31.3 kB]</span><br><span class="line">获取:4 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 ieee-data all 20180805.1 [1,589 kB]</span><br><span class="line">获取:5 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/main amd64 python3-netaddr all 0.7.19-3ubuntu1 [236 kB]</span><br><span class="line">获取:6 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 bpfcc-tools all 0.12.0-2 [579 kB]</span><br><span class="line">获取:8 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 libllvm10 amd64 1:10.0.0-4ubuntu1 [15.3 MB]</span><br><span class="line">获取:30 http://security.ubuntu.com/ubuntu focal-security/main amd64 lib32gcc-s1 amd64 10.5.0-1ubuntu1~20.04 [49.1 kB]</span><br><span class="line">获取:31 http://security.ubuntu.com/ubuntu focal-security/main amd64 lib32stdc++6 amd64 10.5.0-1ubuntu1~20.04 [522 kB]</span><br><span class="line">获取:9 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang-cpp10 amd64 1:10.0.0-4ubuntu1 [9,944 kB]</span><br><span class="line">获取:32 http://security.ubuntu.com/ubuntu focal-security/main amd64 libelf-dev amd64 0.176-1.1ubuntu0.1 [57.1 kB]</span><br><span class="line">获取:33 http://security.ubuntu.com/ubuntu focal-security/main amd64 libncurses-dev amd64 6.2-0ubuntu2.1 [340 kB]</span><br><span class="line">获取:10 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/main amd64 libc6-i386 amd64 2.31-0ubuntu9.9 [2,730 kB]</span><br><span class="line">获取:11 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang-common-10-dev amd64 1:10.0.0-4ubuntu1 [5,012 kB]</span><br><span class="line">获取:34 http://security.ubuntu.com/ubuntu focal-security/main amd64 libtinfo-dev amd64 6.2-0ubuntu2.1 [972 B]</span><br><span class="line">获取:35 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-tools-common all 5.4.0-163.180 [197 kB]</span><br><span class="line">获取:12 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libclang1-10 amd64 1:10.0.0-4ubuntu1 [7,571 kB]</span><br><span class="line">获取:36 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-hwe-5.15-tools-5.15.0-79 amd64 5.15.0-79.86~20.04.2 [7,296 kB]</span><br><span class="line">获取:13 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 clang-10 amd64 1:10.0.0-4ubuntu1 [66.9 kB]</span><br><span class="line">获取:14 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 clang amd64 1:10.0-50~exp1 [3,276 B]</span><br><span class="line">获取:15 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/universe amd64 libbpf0 amd64 1:0.5.0-1~ubuntu20.04.1 [128 kB]</span><br><span class="line">获取:16 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/universe amd64 libbpf-dev amd64 1:0.5.0-1~ubuntu20.04.1 [188 kB]</span><br><span class="line">获取:17 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libbpfcc-dev amd64 0.12.0-2 [16.4 kB]</span><br><span class="line">获取:18 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libomp5-10 amd64 1:10.0.0-4ubuntu1 [300 kB]</span><br><span class="line">获取:19 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libomp-10-dev amd64 1:10.0.0-4ubuntu1 [47.7 kB]</span><br><span class="line">获取:20 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-runtime amd64 1:10.0.0-4ubuntu1 [180 kB]</span><br><span class="line">获取:21 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-runtime amd64 1:10.0-50~exp1 [2,916 B]</span><br><span class="line">获取:22 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 libpfm4 amd64 4.10.1+git20-g7700f49-2 [266 kB]</span><br><span class="line">获取:23 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10 amd64 1:10.0.0-4ubuntu1 [5,214 kB]</span><br><span class="line">获取:24 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm amd64 1:10.0-50~exp1 [3,880 B]</span><br><span class="line">获取:25 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-tools amd64 1:10.0.0-4ubuntu1 [317 kB]</span><br><span class="line">获取:26 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libz3-4 amd64 4.8.7-4build1 [6,792 kB]</span><br><span class="line">获取:27 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 libz3-dev amd64 4.8.7-4build1 [67.5 kB]</span><br><span class="line">获取:28 http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/universe amd64 llvm-10-dev amd64 1:10.0.0-4ubuntu1 [26.0 MB]</span><br><span class="line">获取:37 http://security.ubuntu.com/ubuntu focal-security/main amd64 linux-tools-5.15.0-79-generic amd64 5.15.0-79.86~20.04.2 [2,008 B]</span><br><span class="line">获取:38 http://security.ubuntu.com/ubuntu focal-security/main amd64 python3-pygments all 2.3.1+dfsg-1ubuntu2.2 [579 kB]</span><br><span class="line">已下载 107 MB，耗时 14秒 (7,800 kB/s)</span><br><span class="line">正在从软件包中解出模板：100%</span><br><span class="line">(正在读取数据库 ... 系统当前共安装有 208477 个文件和目录。)</span><br><span class="line">准备解压 .../00-libdw1_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libdw1:amd64 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">准备解压 .../01-libelf1_0.176-1.1ubuntu0.1_i386.deb  ...</span><br><span class="line">正在反配置 libelf1:amd64 (0.176-1.1build1) ...</span><br><span class="line">正在解压 libelf1:i386 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">准备解压 .../02-libelf1_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libelf1:amd64 (0.176-1.1ubuntu0.1) 并覆盖 (0.176-1.1build1) ...</span><br><span class="line">正在选中未选择的软件包 binfmt-support。</span><br><span class="line">准备解压 .../03-binfmt-support_2.2.0-2_amd64.deb  ...</span><br><span class="line">正在解压 binfmt-support (2.2.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libbpfcc。</span><br><span class="line">准备解压 .../04-libbpfcc_0.12.0-2_amd64.deb  ...</span><br><span class="line">正在解压 libbpfcc (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 python3-bpfcc。</span><br><span class="line">准备解压 .../05-python3-bpfcc_0.12.0-2_all.deb  ...</span><br><span class="line">正在解压 python3-bpfcc (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 ieee-data。</span><br><span class="line">准备解压 .../06-ieee-data_20180805.1_all.deb  ...</span><br><span class="line">正在解压 ieee-data (20180805.1) ...</span><br><span class="line">正在选中未选择的软件包 python3-netaddr。</span><br><span class="line">准备解压 .../07-python3-netaddr_0.7.19-3ubuntu1_all.deb  ...</span><br><span class="line">正在解压 python3-netaddr (0.7.19-3ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 bpfcc-tools。</span><br><span class="line">准备解压 .../08-bpfcc-tools_0.12.0-2_all.deb  ...</span><br><span class="line">正在解压 bpfcc-tools (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libllvm10:amd64。</span><br><span class="line">准备解压 .../09-libllvm10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libllvm10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libclang-cpp10。</span><br><span class="line">准备解压 .../10-libclang-cpp10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang-cpp10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libobjc4:amd64。</span><br><span class="line">准备解压 .../11-libobjc4_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 libobjc4:amd64 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 libobjc-9-dev:amd64。</span><br><span class="line">准备解压 .../12-libobjc-9-dev_9.4.0-1ubuntu1~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 libobjc-9-dev:amd64 (9.4.0-1ubuntu1~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 libc6-i386。</span><br><span class="line">准备解压 .../13-libc6-i386_2.31-0ubuntu9.9_amd64.deb  ...</span><br><span class="line">正在解压 libc6-i386 (2.31-0ubuntu9.9) ...</span><br><span class="line">被已安装的软件包 libc6:i386 (2.31-0ubuntu9.9) 中的文件替换了...</span><br><span class="line">正在选中未选择的软件包 lib32gcc-s1。</span><br><span class="line">准备解压 .../14-lib32gcc-s1_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 lib32gcc-s1 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 lib32stdc++6。</span><br><span class="line">准备解压 .../15-lib32stdc++6_10.5.0-1ubuntu1~20.04_amd64.deb  ...</span><br><span class="line">正在解压 lib32stdc++6 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在选中未选择的软件包 libclang-common-10-dev。</span><br><span class="line">准备解压 .../16-libclang-common-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang-common-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libclang1-10。</span><br><span class="line">准备解压 .../17-libclang1-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libclang1-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 clang-10。</span><br><span class="line">准备解压 .../18-clang-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 clang-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 clang。</span><br><span class="line">准备解压 .../19-clang_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 clang (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 libbpf0:amd64。</span><br><span class="line">准备解压 .../20-libbpf0_1%3a0.5.0-1~ubuntu20.04.1_amd64.deb  ...</span><br><span class="line">正在解压 libbpf0:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在选中未选择的软件包 libelf-dev:amd64。</span><br><span class="line">准备解压 .../21-libelf-dev_0.176-1.1ubuntu0.1_amd64.deb  ...</span><br><span class="line">正在解压 libelf-dev:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在选中未选择的软件包 libbpf-dev:amd64。</span><br><span class="line">准备解压 .../22-libbpf-dev_1%3a0.5.0-1~ubuntu20.04.1_amd64.deb  ...</span><br><span class="line">正在解压 libbpf-dev:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在选中未选择的软件包 libbpfcc-dev。</span><br><span class="line">准备解压 .../23-libbpfcc-dev_0.12.0-2_amd64.deb  ...</span><br><span class="line">正在解压 libbpfcc-dev (0.12.0-2) ...</span><br><span class="line">正在选中未选择的软件包 libncurses-dev:amd64。</span><br><span class="line">准备解压 .../24-libncurses-dev_6.2-0ubuntu2.1_amd64.deb  ...</span><br><span class="line">正在解压 libncurses-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在选中未选择的软件包 libomp5-10:amd64。</span><br><span class="line">准备解压 .../25-libomp5-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libomp5-10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libomp-10-dev。</span><br><span class="line">准备解压 .../26-libomp-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 libomp-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libtinfo-dev:amd64。</span><br><span class="line">准备解压 .../27-libtinfo-dev_6.2-0ubuntu2.1_amd64.deb  ...</span><br><span class="line">正在解压 libtinfo-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在选中未选择的软件包 linux-tools-common。</span><br><span class="line">准备解压 .../28-linux-tools-common_5.4.0-163.180_all.deb  ...</span><br><span class="line">正在解压 linux-tools-common (5.4.0-163.180) ...</span><br><span class="line">正在选中未选择的软件包 linux-hwe-5.15-tools-5.15.0-79。</span><br><span class="line">准备解压 .../29-linux-hwe-5.15-tools-5.15.0-79_5.15.0-79.86~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 linux-hwe-5.15-tools-5.15.0-79 (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 linux-tools-5.15.0-79-generic。</span><br><span class="line">准备解压 .../30-linux-tools-5.15.0-79-generic_5.15.0-79.86~20.04.2_amd64.deb  ...</span><br><span class="line">正在解压 linux-tools-5.15.0-79-generic (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-runtime。</span><br><span class="line">准备解压 .../31-llvm-10-runtime_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-runtime (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 llvm-runtime。</span><br><span class="line">准备解压 .../32-llvm-runtime_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-runtime (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 libpfm4:amd64。</span><br><span class="line">准备解压 .../33-libpfm4_4.10.1+git20-g7700f49-2_amd64.deb  ...</span><br><span class="line">正在解压 libpfm4:amd64 (4.10.1+git20-g7700f49-2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10。</span><br><span class="line">准备解压 .../34-llvm-10_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 llvm。</span><br><span class="line">准备解压 .../35-llvm_1%3a10.0-50~exp1_amd64.deb  ...</span><br><span class="line">正在解压 llvm (1:10.0-50~exp1) ...</span><br><span class="line">正在选中未选择的软件包 python3-pygments。</span><br><span class="line">准备解压 .../36-python3-pygments_2.3.1+dfsg-1ubuntu2.2_all.deb  ...</span><br><span class="line">正在解压 python3-pygments (2.3.1+dfsg-1ubuntu2.2) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-tools。</span><br><span class="line">准备解压 .../37-llvm-10-tools_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-tools (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在选中未选择的软件包 libz3-4:amd64。</span><br><span class="line">准备解压 .../38-libz3-4_4.8.7-4build1_amd64.deb  ...</span><br><span class="line">正在解压 libz3-4:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在选中未选择的软件包 libz3-dev:amd64。</span><br><span class="line">准备解压 .../39-libz3-dev_4.8.7-4build1_amd64.deb  ...</span><br><span class="line">正在解压 libz3-dev:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在选中未选择的软件包 llvm-10-dev。</span><br><span class="line">准备解压 .../40-llvm-10-dev_1%3a10.0.0-4ubuntu1_amd64.deb  ...</span><br><span class="line">正在解压 llvm-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libncurses-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在设置 libobjc4:amd64 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 libllvm10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 python3-pygments (2.3.1+dfsg-1ubuntu2.2) ...</span><br><span class="line">正在设置 libz3-4:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在设置 libpfm4:amd64 (4.10.1+git20-g7700f49-2) ...</span><br><span class="line">正在设置 libclang1-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 binfmt-support (2.2.0-2) ...</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/binfmt-support.service → /lib/systemd/system/binfmt-support.service.</span><br><span class="line">正在设置 libobjc-9-dev:amd64 (9.4.0-1ubuntu1~20.04.2) ...</span><br><span class="line">正在设置 ieee-data (20180805.1) ...</span><br><span class="line">正在设置 libomp5-10:amd64 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libc6-i386 (2.31-0ubuntu9.9) ...</span><br><span class="line">正在设置 libelf1:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 libelf1:i386 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 linux-tools-common (5.4.0-163.180) ...</span><br><span class="line">正在设置 libtinfo-dev:amd64 (6.2-0ubuntu2.1) ...</span><br><span class="line">正在设置 libz3-dev:amd64 (4.8.7-4build1) ...</span><br><span class="line">正在设置 libdw1:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 llvm-10-tools (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libomp-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 libclang-cpp10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 llvm-10-runtime (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 lib32gcc-s1 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 lib32stdc++6 (10.5.0-1ubuntu1~20.04) ...</span><br><span class="line">正在设置 llvm-runtime (1:10.0-50~exp1) ...</span><br><span class="line">正在设置 libelf-dev:amd64 (0.176-1.1ubuntu0.1) ...</span><br><span class="line">正在设置 python3-netaddr (0.7.19-3ubuntu1) ...</span><br><span class="line">正在设置 libbpf0:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在设置 libbpfcc (0.12.0-2) ...</span><br><span class="line">正在设置 python3-bpfcc (0.12.0-2) ...</span><br><span class="line">正在设置 linux-hwe-5.15-tools-5.15.0-79 (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在设置 libbpf-dev:amd64 (1:0.5.0-1~ubuntu20.04.1) ...</span><br><span class="line">正在设置 libclang-common-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 linux-tools-5.15.0-79-generic (5.15.0-79.86~20.04.2) ...</span><br><span class="line">正在设置 llvm-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 llvm-10-dev (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 bpfcc-tools (0.12.0-2) ...</span><br><span class="line">正在设置 libbpfcc-dev (0.12.0-2) ...</span><br><span class="line">正在设置 llvm (1:10.0-50~exp1) ...</span><br><span class="line">正在设置 clang-10 (1:10.0.0-4ubuntu1) ...</span><br><span class="line">正在设置 clang (1:10.0-50~exp1) ...</span><br><span class="line">正在处理用于 systemd (245.4-4ubuntu3.20) 的触发器 ...</span><br><span class="line">正在处理用于 man-db (2.9.1-1) 的触发器 ...</span><br><span class="line">正在处理用于 libc-bin (2.31-0ubuntu9.9) 的触发器 ...</span><br><span class="line">root@k8smaster:/home/mobb<span class="comment"># mkdir eBPF_test</span></span><br><span class="line">root@k8smaster:/home/mobb<span class="comment"># cd eBPF_test</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># vim hello.py</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># python3 hello.py</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;hello.py&quot;</span>, line 11, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    b = BPF(src_file=<span class="string">&quot;hello.c&quot;</span>)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 317, <span class="keyword">in</span> __init__</span><br><span class="line">    src_file = BPF._find_file(src_file)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 246, <span class="keyword">in</span> _find_file</span><br><span class="line">    raise Exception(<span class="string">&quot;Could not find file %s&quot;</span> % filename)</span><br><span class="line">Exception: Could not find file b<span class="string">&#x27;hello.c&#x27;</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment">#  cat /boot/config-5.15.0-79-generic |grep BPF</span></span><br><span class="line">CONFIG_BPF=y</span><br><span class="line">CONFIG_HAVE_EBPF_JIT=y</span><br><span class="line">CONFIG_ARCH_WANT_DEFAULT_BPF_JIT=y</span><br><span class="line"><span class="comment"># BPF subsystem</span></span><br><span class="line">CONFIG_BPF_SYSCALL=y</span><br><span class="line">CONFIG_BPF_JIT=y</span><br><span class="line">CONFIG_BPF_JIT_ALWAYS_ON=y</span><br><span class="line">CONFIG_BPF_JIT_DEFAULT_ON=y</span><br><span class="line">CONFIG_BPF_UNPRIV_DEFAULT_OFF=y</span><br><span class="line"><span class="comment"># CONFIG_BPF_PRELOAD is not set</span></span><br><span class="line">CONFIG_BPF_LSM=y</span><br><span class="line"><span class="comment"># end of BPF subsystem</span></span><br><span class="line">CONFIG_CGROUP_BPF=y</span><br><span class="line">CONFIG_IPV6_SEG6_BPF=y</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_BPF=m</span><br><span class="line">CONFIG_BPFILTER=y</span><br><span class="line">CONFIG_BPFILTER_UMH=m</span><br><span class="line">CONFIG_NET_CLS_BPF=m</span><br><span class="line">CONFIG_NET_ACT_BPF=m</span><br><span class="line">CONFIG_BPF_STREAM_PARSER=y</span><br><span class="line">CONFIG_LWTUNNEL_BPF=y</span><br><span class="line">CONFIG_BPF_EVENTS=y</span><br><span class="line">CONFIG_BPF_KPROBE_OVERRIDE=y</span><br><span class="line">CONFIG_TEST_BPF=m</span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># apt install python3-bpfcc</span></span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树</span><br><span class="line">正在读取状态信息... 完成</span><br><span class="line">python3-bpfcc 已经是最新版 (0.12.0-2)。</span><br><span class="line">python3-bpfcc 已设置为手动安装。</span><br><span class="line">下列软件包是自动安装的并且现在不需要了：</span><br><span class="line">  libcbor0.6 libfido2-1</span><br><span class="line">使用<span class="string">&#x27;apt autoremove&#x27;</span>来卸载它(它们)。</span><br><span class="line">升级了 0 个软件包，新安装了 0 个软件包，要卸载 0 个软件包，有 156 个软件包未被升级。</span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># python3 hello.py</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;hello.py&quot;</span>, line 11, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    b = BPF(src_file=<span class="string">&quot;hello.c&quot;</span>)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 317, <span class="keyword">in</span> __init__</span><br><span class="line">    src_file = BPF._find_file(src_file)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 246, <span class="keyword">in</span> _find_file</span><br><span class="line">    raise Exception(<span class="string">&quot;Could not find file %s&quot;</span> % filename)</span><br><span class="line">Exception: Could not find file b<span class="string">&#x27;hello.c&#x27;</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># export PYTHONPATH=$(dirname `find /usr/lib -name bcc`):$PYTHONPATH</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># python3 hello.py</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;hello.py&quot;</span>, line 11, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    b = BPF(src_file=<span class="string">&quot;hello.c&quot;</span>)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 317, <span class="keyword">in</span> __init__</span><br><span class="line">    src_file = BPF._find_file(src_file)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line 246, <span class="keyword">in</span> _find_file</span><br><span class="line">    raise Exception(<span class="string">&quot;Could not find file %s&quot;</span> % filename)</span><br><span class="line">Exception: Could not find file b<span class="string">&#x27;hello.c&#x27;</span></span><br><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># cd ..</span></span><br><span class="line">root@k8smaster:/home/mobb<span class="comment"># git clone https://github.com/libbpf/libbpf.git</span></span><br><span class="line">正克隆到 <span class="string">&#x27;libbpf&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 11028, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (2406/2406), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (539/539), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 11028 (delta 1858), reused 1918 (delta 1836), pack-reused 8622</span><br><span class="line">接收对象中: 100% (11028/11028), 8.16 MiB | 4.65 MiB/s, 完成.</span><br><span class="line">处理 delta 中: 100% (7421/7421), 完成.</span><br><span class="line">root@k8smaster:/home/mobb<span class="comment"># ls</span></span><br><span class="line">公共的  音乐                        dashboard-svc.yaml  pwndbg</span><br><span class="line">模板    桌面                        deepflow_pv.yaml    recommended.yaml</span><br><span class="line">视频    components.yaml             eBPF_test           sealos_4.3.2_linux_amd64.tar.gz</span><br><span class="line">图片    components.yaml.1           ingress-controller  sealos_4.3.2_linux_amd64.tar.gz.1</span><br><span class="line">文档    config.yaml                 libbpf</span><br><span class="line">下载    dashboard-svc-account.yaml  metrics-server</span><br><span class="line">root@k8smaster:/home/mobb<span class="comment"># cd libbpf</span></span><br><span class="line">root@k8smaster:/home/mobb/libbpf<span class="comment"># ls</span></span><br><span class="line">assets                 ci    include               LICENSE.LGPL-2.1  src</span><br><span class="line">BPF-CHECKPOINT-COMMIT  docs  LICENSE               README.md         SYNC.md</span><br><span class="line">CHECKPOINT-COMMIT      fuzz  LICENSE.BSD-2-Clause  scripts</span><br><span class="line">root@k8smaster:/home/mobb/libbpf<span class="comment"># cd src</span></span><br><span class="line">root@k8smaster:/home/mobb/libbpf/src<span class="comment"># ls</span></span><br><span class="line">bpf.c               btf.c            libbpf_errno.c      Makefile         str_error.h</span><br><span class="line">bpf_core_read.h     btf_dump.c       libbpf.h            netlink.c        strset.c</span><br><span class="line">bpf_endian.h        btf.h            libbpf_internal.h   nlattr.c         strset.h</span><br><span class="line">bpf_gen_internal.h  elf.c            libbpf_legacy.h     nlattr.h         usdt.bpf.h</span><br><span class="line">bpf.h               gen_loader.c     libbpf.map          relo_core.c      usdt.c</span><br><span class="line">bpf_helper_defs.h   hashmap.c        libbpf.pc.template  relo_core.h      zip.c</span><br><span class="line">bpf_helpers.h       hashmap.h        libbpf_probes.c     ringbuf.c        zip.h</span><br><span class="line">bpf_prog_linfo.c    libbpf.c         libbpf_version.h    skel_internal.h</span><br><span class="line">bpf_tracing.h       libbpf_common.h  linker.c            str_error.c</span><br><span class="line">root@k8smaster:/home/mobb/libbpf/src<span class="comment"># make</span></span><br><span class="line">  MKDIR    staticobjs</span><br><span class="line">  CC       staticobjs/bpf.o</span><br><span class="line">  CC       staticobjs/btf.o</span><br><span class="line">  CC       staticobjs/libbpf.o</span><br><span class="line">  CC       staticobjs/libbpf_errno.o</span><br><span class="line">  CC       staticobjs/netlink.o</span><br><span class="line">  CC       staticobjs/nlattr.o</span><br><span class="line">  CC       staticobjs/str_error.o</span><br><span class="line">  CC       staticobjs/libbpf_probes.o</span><br><span class="line">  CC       staticobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       staticobjs/btf_dump.o</span><br><span class="line">  CC       staticobjs/hashmap.o</span><br><span class="line">  CC       staticobjs/ringbuf.o</span><br><span class="line">  CC       staticobjs/strset.o</span><br><span class="line">  CC       staticobjs/linker.o</span><br><span class="line">  CC       staticobjs/gen_loader.o</span><br><span class="line">  CC       staticobjs/relo_core.o</span><br><span class="line">  CC       staticobjs/usdt.o</span><br><span class="line">  CC       staticobjs/zip.o</span><br><span class="line">  CC       staticobjs/elf.o</span><br><span class="line">  AR       libbpf.a</span><br><span class="line">  MKDIR    sharedobjs</span><br><span class="line">  CC       sharedobjs/bpf.o</span><br><span class="line">  CC       sharedobjs/btf.o</span><br><span class="line">  CC       sharedobjs/libbpf.o</span><br><span class="line">  CC       sharedobjs/libbpf_errno.o</span><br><span class="line">  CC       sharedobjs/netlink.o</span><br><span class="line">  CC       sharedobjs/nlattr.o</span><br><span class="line">  CC       sharedobjs/str_error.o</span><br><span class="line">  CC       sharedobjs/libbpf_probes.o</span><br><span class="line">  CC       sharedobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       sharedobjs/btf_dump.o</span><br><span class="line">  CC       sharedobjs/hashmap.o</span><br><span class="line">  CC       sharedobjs/ringbuf.o</span><br><span class="line">  CC       sharedobjs/strset.o</span><br><span class="line">  CC       sharedobjs/linker.o</span><br><span class="line">  CC       sharedobjs/gen_loader.o</span><br><span class="line">  CC       sharedobjs/relo_core.o</span><br><span class="line">  CC       sharedobjs/usdt.o</span><br><span class="line">  CC       sharedobjs/zip.o</span><br><span class="line">  CC       sharedobjs/elf.o</span><br><span class="line">  CC       libbpf.so.1.3.0</span><br></pre></td></tr></table></figure>

<p>然后再编译这里的样例代码</p>
<p><a target="_blank" rel="noopener" href="https://www.zadmei.com/ckmjkfby.html">初窥门径：开发并运行你的第一个 eBPF 程序-火焰兔 (zadmei.com)</a></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230925235543208.png" alt="image-20230925235543208"></p>
<p>应该是可以了</p>
<h3 id="我是分割线"><a href="#我是分割线" class="headerlink" title="我是分割线"></a>我是分割线</h3><h2 id="真正的eBPF开发环境搭建"><a href="#真正的eBPF开发环境搭建" class="headerlink" title="真正的eBPF开发环境搭建"></a>真正的eBPF开发环境搭建</h2><p>经过漫长的试错和研究，我发现了之前的问题所在，在拉取镜像之后的CMAKE环节这里是没什么问题的，但是在make的时候，总是会在百分之38左右的位置，直接报错，然后显示失败，查看了CMakeCache.txt文件后，发现了一个问题：<code>每次编译都会调用LLVM10</code>，而报错内容会显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In file included from /usr/lib/llvm-10/include/clang/AST/RecursiveASTVisitor.h:16,</span><br><span class="line">                 from /home/mobb/bcc/src/cc/frontends/clang/b_frontend_action.h:23,</span><br><span class="line">                 from /home/mobb/bcc/src/cc/frontends/clang/b_frontend_action.cc:31:</span><br><span class="line">/usr/lib/llvm-10/include/clang/AST/Attr.h: In static member <span class="keyword">function</span> ‘static clang::ParamIdx clang::ParamIdx::deserialize(clang::ParamIdx::SerialType)’:</span><br><span class="line">/usr/lib/llvm-10/include/clang/AST/Attr.h:261:17: warning: dereferencing type-punned pointer will <span class="built_in">break</span> strict-aliasing rules [-Wstrict-aliasing]</span><br><span class="line">  261 |     ParamIdx P(*reinterpret_cast&lt;ParamIdx *&gt;(&amp;S));</span><br><span class="line">      |                 ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">/usr/lib/llvm-10/include/clang/AST/Attr.h:261:17: warning: dereferencing type-punned pointer will <span class="built_in">break</span> strict-aliasing rules [-Wstrict-aliasing]</span><br><span class="line"></span><br><span class="line">/usr/bin/ld: /usr/lib/llvm-10/lib/libclangCodeGen.a(BackendUtil.cpp.o): <span class="keyword">in</span> <span class="keyword">function</span> `(anonymous namespace)::EmitAssemblyHelper::EmitAssemblyWithNewPassManager(clang::BackendAction, std::unique_ptr&lt;llvm::raw_pwrite_stream, std::default_delete&lt;llvm::raw_pwrite_stream&gt; &gt;)<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">(.text._ZN12_GLOBAL__N_118EmitAssemblyHelper30EmitAssemblyWithNewPassManagerEN5clang13BackendActionESt10unique_ptrIN4llvm17raw_pwrite_streamESt14default_deleteIS5_EE+0x1f15): undefined reference to `getPollyPluginInfo()&#x27;</span></span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make[2]: *** [examples/cpp/CMakeFiles/CGroupTest.dir/build.make:158：examples/cpp/CGroupTest] 错误 1</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:1146：examples/cpp/CMakeFiles/CGroupTest.dir/all] 错误 2</span><br><span class="line">make: *** [Makefile:141：all] 错误 2</span><br></pre></td></tr></table></figure>

<p>总之会指向一个问题，在LLVM里面找不到getPollyPluginInfo()这个函数，我之前以为我是我安装的LLVM12的问题，但是查阅了相关信息，LLVM12是有相关的函数的，所以实际上是没有把LLVM10卸载，然后还需要把LLVM12添加到PATH环境当中。</p>
<p>接下来开始进行环境的安装</p>
<p>参考文档</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43966076/article/details/132618984">ubuntu20.04安装bcc_JD怕秃头的博客-CSDN博客</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y g++ libmicrohttpd-dev libsqlite3-dev libarchive-dev libcurl4-openssl-dev gettext libzstd-dev pkg-config</span><br><span class="line">sudo apt install make</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009155936385.png" alt="image-20231009155936385"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install zlib1g-dev</span><br><span class="line">sudo apt-get install libbz2-dev</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009160027923.png" alt="image-20231009160027923"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y bison build-essential cmake flex git libedit-dev liblzma-dev \</span><br><span class="line">libllvm12 llvm-12-dev libclang-12-dev zlib1g-dev libelf-dev libfl-dev python3-distutils</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009162608158.png" alt="image-20231009162608158"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install arping netperf iperf</span><br><span class="line">sudo apt install libbpfcc</span><br><span class="line">sudo apt install python3-bpfcc</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009162724262.png" alt="image-20231009162724262"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009162732995.png" alt="image-20231009162732995"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009163043219.png" alt="image-20231009163043219"></p>
<p><strong>安装elfutils</strong><br>elfutils可以生成bcc需要的动态库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://sourceware.org/elfutils/ftp/0.188/elfutils-0.188.tar.bz2</span><br><span class="line">tar xvf elfutils-0.188.tar.bz2</span><br><span class="line">mkdir elfutils-0.188/build </span><br><span class="line"><span class="built_in">cd</span> elfutils-0.188/build/ </span><br><span class="line">../configure</span><br></pre></td></tr></table></figure>

<p>记得要让这里的<code>should all be yes</code>全都是yes</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009185222905.png" alt="image-20231009185222905"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>这里出了点错误，因为我在检验我是否安装成功的时候看到了报错</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/elfutils-0.188/build<span class="comment"># /usr/local/bin/eu-readelf --version</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/eu-readelf: /lib/x86_64-linux-gnu/libdw.so.1: version `ELFUTILS_0.177<span class="string">&#x27; not found (required by /usr/local/bin/eu-readelf)</span></span><br></pre></td></tr></table></figure>

<p><code>eu-readelf</code> 版本与 <code>libdw</code> 库版本不匹配。<code>eu-readelf</code> 需要的 <code>libdw</code> 库版本是 <code>ELFUTILS_0.177</code>，但实际安装的 <code>libdw</code> 版本不符合要求。</p>
<p>这可能是系统中同时存在多个版本的 <code>libdw</code> 库导致的</p>
<p>所以找一下系统中的libdw库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/elfutils-0.188/build<span class="comment"># find / -name libdw.so*</span></span><br><span class="line">/home/lab1/elfutils-0.188/build/libdw/libdw.so.1</span><br><span class="line">/home/lab1/elfutils-0.188/build/libdw/libdw.so</span><br><span class="line">/var/lib/docker/overlay2/6310b69a4afce7b65b94f0a38b6aab25057152455ddd5f1134537a7bd75474b9/diff/usr/lib64/libdw.so.1</span><br><span class="line">/usr/<span class="built_in">local</span>/lib/libdw.so.1</span><br><span class="line">/usr/<span class="built_in">local</span>/lib/libdw.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libdw.so.1</span><br></pre></td></tr></table></figure>

<p><strong>移除旧版本的 libdw 库</strong>：移除以下路径的库：</p>
<ul>
<li><code>/usr/lib/x86_64-linux-gnu/libdw.so.1</code></li>
<li><code>/var/lib/docker/overlay2/6310b69a4afce7b65b94f0a38b6aab25057152455ddd5f1134537a7bd75474b9/diff/usr/lib64/libdw.so.1</code></li>
</ul>
<p>然后再重新安装，从解压那一部分重新开始。重新安装之后依然遇到了问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/elfutils-0.188/build<span class="comment"># /usr/local/bin/eu-readelf --version</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/eu-readelf: error <span class="keyword">while</span> loading shared libraries: libdw.so.1: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p>这个错误表明 <code>eu-readelf</code> 程序在运行时无法找到所需的共享库文件 <code>libdw.so.1</code>。这通常是因为系统没有正确配置共享库搜索路径</p>
<p>添加共享库搜索路径：</p>
<p>打开文件 <code>/etc/ld.so.conf</code> 以编辑共享库的搜索路径。使用以下命令以 root 用户编辑该文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ld.so.conf</span><br></pre></td></tr></table></figure>

<p>在文件中添加一行，指向 elfutils 的安装目录，通常是 <code>/usr/local/lib</code>，然后保存并退出编辑器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lib</span><br></pre></td></tr></table></figure>

<p>更新共享库缓存：</p>
<p>运行以下命令来更新共享库缓存：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/eu-readelf --version</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009193200756.png" alt="image-20231009193200756"></p>
<p>只要这样就是成功了</p>
<p>接下来安装bcc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/iovisor/bcc.git</span><br><span class="line">mkdir bcc/build; <span class="built_in">cd</span> bcc/build</span><br></pre></td></tr></table></figure>

<p>这里要先看看有没有安装的llvm</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-config --version</span><br></pre></td></tr></table></figure>

<p>这里没有输出不代表就没有安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo find /usr -name llvm-config</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009193654090-16968514148391.png" alt="image-20231009193654090"></p>
<p>这里要删掉llvm-10</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove llvm-10</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009193819635.png" alt="image-20231009193819635"></p>
<p>删除之后还需要吧llvm12添加到path中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>添加这个到文件最后一行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/lib/llvm-12/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>重新加载 shell 配置文件以使更改生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009194522483-16968519239703.png" alt="image-20231009194522483"></p>
<p>这样就行了</p>
<p>接下来在bcc/build目录下进行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009195450414.png" alt="image-20231009195450414"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009195524449.png" alt="image-20231009195524449"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DPYTHON_CMD=python3 .. <span class="comment"># build python3 binding</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009195825757.png" alt="image-20231009195825757"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pushd</span> src/python/</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009195846686.png" alt="image-20231009195846686"></p>
<p>进入/usr/share/bcc/tools中进行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ./tcptop</span><br></pre></td></tr></table></figure>

<p>然后就一直报这样的错，明明在安装的时候是没有任何错误的。</p>
<p>搜寻了好久，最后直接进官网的issues上找到了相同的问题</p>
<p><a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/issues/4583">AttributeError: /lib/x86_64-linux-gnu/libbcc.so.0: undefined symbol: bpf_module_create_b · Issue #4583 · iovisor/bcc (github.com)</a></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009222149984.png" alt="image-20231009222149984"></p>
<p>感谢这位大哥的建议，很可能之前有冗杂的bcc安装。</p>
<p>所以需要删掉<code>/usr/lib/python3/dist-packages/bcc</code>这个目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove --purge bpfcc-tools python3-bpfcc</span><br></pre></td></tr></table></figure>

<p>接着删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /usr/lib/python3/dist-packages/bcc</span><br></pre></td></tr></table></figure>

<p>然后重新安装一次，就可以了</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231009222828964.png" alt="image-20231009222828964"></p>
<h2 id="bpftool"><a href="#bpftool" class="headerlink" title="bpftool"></a>bpftool</h2><p>在使用bpftool的时候有个报错</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb/eBPF_test<span class="comment"># sudo bpftool prog list</span></span><br><span class="line">WARNING: bpftool not found <span class="keyword">for</span> kernel 5.15.0-84</span><br><span class="line"></span><br><span class="line">  You may need to install the following packages <span class="keyword">for</span> this specific kernel:</span><br><span class="line">    linux-tools-5.15.0-84-generic</span><br><span class="line">    linux-cloud-tools-5.15.0-84-generic</span><br><span class="line"></span><br><span class="line">  You may also want to install one of the following packages to keep up to date:</span><br><span class="line">    linux-tools-generic</span><br><span class="line">    linux-cloud-tools-generic</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>按照提示安装这些：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"> sudo apt install linux-tools-5.15.0-84-generic linux-cloud-tools-5.15.0-84-generic</span><br></pre></td></tr></table></figure>

<p>安装完之后就可以使用了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftool prog list</span><br></pre></td></tr></table></figure>

<p>查看系统中正在运行的ebpf程序</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230926203506993.png" alt="image-20230926203506993"></p>
<p>输出中，45是这个 eBPF 程序的编号，kprobe 是程序的类型，而 memlock是程序的名字。</p>
<p>有了 eBPF 程序编号之后，执行下面的命令就可以导出这个 eBPF 程序的指令（注意把 45替换成你查询到的编号）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftool prog dump xlated id 45</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230926203618491.png" alt="image-20230926203618491"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure>

<p>BPF 系统调用接受三个参数：</p>
<p>第一个，cmd ，代表操作命令，比如上一讲中我们看到的 BPF_PROG_LOAD 就是加载 eBPF 程序；</p>
<p>第二个，attr，代表 bpf_attr 类型的 eBPF 属性指针，不同类型的操作命令需要传入不同的属性参数；</p>
<p>第三个，size ，代表属性的大小。</p>
<h1 id="Agent调试"><a href="#Agent调试" class="headerlink" title="Agent调试"></a>Agent调试</h1><p>因为在使用官方调试环境时出现了报错</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230927002829279.png" alt="image-20230927002829279"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/deepflowio/deepflow.git </span><br><span class="line"><span class="built_in">cd</span> deepflow </span><br><span class="line">docker run --privileged --rm -it -v \</span><br><span class="line">    $(<span class="built_in">pwd</span>):/deepflow -v ~/.cargo:/usr/<span class="built_in">local</span>/cargo hub.deepflow.yunshan.net/public/rust-build bash -c \</span><br><span class="line">    <span class="string">&quot;source /opt/rh/devtoolset-8/enable &amp;&amp; cd /deepflow/agent &amp;&amp; cargo build&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binary file directory: ./agent/target/debug/deepflow-agent</span></span><br></pre></td></tr></table></figure>

<p>这是关于cargo</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@5e338fc61771 cargo]<span class="comment"># find / -name cargo 2&gt;/dev/null /usr/local/cargo /usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/etc/bash_completion.d/cargo /usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/cargo /usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/share/doc/cargo /usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/share/doc/rust/html/cargo /usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/share/doc/rust/html/rust-by-example/cargo</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从输出来看，<code>cargo</code> 可执行文件位于 <code>/usr/local/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/</code> 目录中。</p>
<p>你可以尝试以下操作来使用 <code>cargo</code>：</p>
<ol>
<li><p><strong>直接使用完整路径</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/cargo --version</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --privileged --rm -it -v     $(<span class="built_in">pwd</span>):/deepflow -v /usr/<span class="built_in">local</span>/cargo hub.deepflow.yunshan.net/public/rust-build bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>将其添加到 <code>PATH</code> 环境变量中</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/</span><br><span class="line">cargo --version</span><br></pre></td></tr></table></figure></li>
</ol>
<p>将其添加到 <code>PATH</code> 后，应该可以在该会话中直接使用 <code>cargo</code> 命令。如果打算经常这样做，可能需要考虑在 Docker 镜像的启动脚本或 <code>bash</code> 配置文件中添加此 <code>PATH</code> 更新，以便每次启动容器时都能自动设置。</p>
<h2 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h2><p>这里虽然cargo build成功了，但是却运行不了</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20230927201954187.png" alt="image-20230927201954187"></p>
<p>更新！！！此时其实已经构建好了编译环境，但是不能直接运行deepflow-agent，这需要加上一些命令选项，具体可以直接运行对应的程序，按照他那个命令来构建环境是可以的</p>
<p>进入容器内部</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --privileged --rm -it -v \</span><br><span class="line">    $(<span class="built_in">pwd</span>):/deepflow -v ~/.cargo:/usr/<span class="built_in">local</span>/cargo hub.deepflow.yunshan.net/public/rust-build bash</span><br></pre></td></tr></table></figure>



<p>命令执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/rh/devtoolset-8/<span class="built_in">enable</span></span><br><span class="line"><span class="built_in">cd</span> /deepflow/agent</span><br><span class="line">cargo build</span><br></pre></td></tr></table></figure>



<h2 id="分析-agent-benches文件夹"><a href="#分析-agent-benches文件夹" class="headerlink" title="分析/agent/benches文件夹"></a>分析/agent/benches文件夹</h2><p>总的来说，这个文件夹是用来进行测试代码性能的，使用的是Criterion库来进行测试。</p>
<p>构建好编译环境之后，可以在benches文件夹下执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo bench</span><br></pre></td></tr></table></figure>

<p>来测试代码</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231007134625064.png" alt="image-20231007134625064"></p>
<h2 id="安装Go以及TinyGo"><a href="#安装Go以及TinyGo" class="headerlink" title="安装Go以及TinyGo"></a>安装Go以及TinyGo</h2><p>下载go的二进制包</p>
<p><a target="_blank" rel="noopener" href="https://golang.google.cn/dl/">All releases - The Go Programming Language (google.cn)</a></p>
<p>然后解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -C /usr/<span class="built_in">local</span> -xzf go1.21.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>-C 选项解压文件到 /usr/local 目录，查看 /usr/local/go 目录的内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/<span class="built_in">local</span>/go</span><br></pre></td></tr></table></figure>

<p>将 Go 二进制文件添加到 $PATH 环境变量中</p>
<p>打开 .bashrc 或者 .bash_profile 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>粘贴如下行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/go/bin</span><br></pre></td></tr></table></figure>

<p>保存更改并退出文件</p>
<p>重新加载 .bashrc 或者 .bash_profile 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>使用 go version 命令查看版本号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go version</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023180626216.png" alt="image-20231023180626216"></p>
<p>安装Tinygo</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/tinygo-org/tinygo/releases/download/v0.30.0/tinygo_0.30.0_amd64.deb</span><br><span class="line">sudo dpkg -i tinygo_0.30.0_amd64.deb</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>

<p>查看是否安装成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tinygo version</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231018231131572.png" alt="image-20231018231131572"></p>
<h2 id="上传wasm插件测试"><a href="#上传wasm插件测试" class="headerlink" title="上传wasm插件测试"></a>上传wasm插件测试</h2><p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023174211627.png" alt="image-20231023174211627"></p>
<p>这次测试的是官网的HTTPv1协议增强，点击链接进入，然后把整个项目压缩包下下来，放入自己选定的文件夹里面。用<code>unzip</code>命令解压之后进入目录。</p>
<p>这时要先移除这里的go.mod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm go.mod</span><br></pre></td></tr></table></figure>

<p>然后重新初始化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod init &lt;你对应的目录&gt;</span><br></pre></td></tr></table></figure>

<p>这时它会提示你要添加一些requirement</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175034138.png" alt="image-20231023175034138"></p>
<p>按着他给的命令执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb/go_wasm1<span class="comment"># go mod init go_wasm1</span></span><br><span class="line">go: creating new go.mod: module go_wasm1</span><br><span class="line">go: to add module requirements and sums:</span><br><span class="line">        go mod tidy</span><br><span class="line">root@k8smaster:/home/mobb/go_wasm1<span class="comment"># go mod tidy</span></span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/sdk</span><br><span class="line">go: finding module <span class="keyword">for</span> package golang.org/x/net/dns/dnsmessage</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/valyala/fastjson</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/example/krpc/pb</span><br><span class="line">go: finding module <span class="keyword">for</span> package google.golang.org/protobuf/reflect/protoreflect</span><br><span class="line">go: finding module <span class="keyword">for</span> package google.golang.org/protobuf/runtime/protoimpl</span><br><span class="line">go: go_wasm1/example/dns imports</span><br><span class="line">        github.com/deepflowio/deepflow-wasm-go-sdk/sdk: module github.com/deepflowio/deepflow-wasm-go-sdk/sdk: Get <span class="string">&quot;https://proxy.golang.org/github.com/deepflowio/deepflow-wasm-go-sdk/sdk/@v/list&quot;</span>: dial tcp 142.251.43.17:443: connect: connection refused</span><br><span class="line">go: go_wasm1/example/dns imports</span><br><span class="line">        golang.org/x/net/dns/dnsmessage: module golang.org/x/net/dns/dnsmessage: Get <span class="string">&quot;https://proxy.golang.org/golang.org/x/net/dns/dnsmessage/@v/list&quot;</span>: dial tcp 142.251.43.17:443: connect: connection refused</span><br><span class="line">go: go_wasm1/example/go_http2_uprobe imports</span><br><span class="line">        github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb: module github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb: Get <span class="string">&quot;https://proxy.golang.org/github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb/@v/list&quot;</span>: dial tcp 142.251.42.241:443: connect: connection refused</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175407098.png" alt="image-20231023175407098"></p>
<p>查看一下go.mod是否有生成</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175438095.png" alt="image-20231023175438095"></p>
<p><code>cd</code>到example目录下的http目录</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175833452.png" alt="image-20231023175833452"></p>
<p>运行一下它官网给的编译命令</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175751296.png" alt="image-20231023175751296"></p>
<p>修改后如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tinygo  build -o wasm.wasm  -target wasi  -panic=<span class="built_in">trap</span> -scheduler=none -no-debug ./http.go</span><br></pre></td></tr></table></figure>

<p>然后他又会告诉你缺少条件依赖，还是按他给的命令去执行</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023175904941.png" alt="image-20231023175904941"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/deepflowio/deepflow-wasm-go-sdk/sdk</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023180125748.png" alt="image-20231023180125748"></p>
<p>遇到了网络问题，这里开一下梯子吧</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb/go_wasm1/example/http<span class="comment"># systemctl start clash</span></span><br><span class="line">root@k8smaster:/home/mobb/go_wasm1/example/http<span class="comment"># export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span></span><br></pre></td></tr></table></figure>

<p>再次执行，这样应该就是成功了</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023180234945.png" alt="image-20231023180234945"></p>
<p>还有一个依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/valyala/fastjson</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023180505644.png" alt="image-20231023180505644"></p>
<p>再次执行一下编译命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tinygo  build -o wasm.wasm  -target wasi  -panic=<span class="built_in">trap</span> -scheduler=none -no-debug ./http.go</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023182607341.png" alt="image-20231023182607341"></p>
<h3 id="lab1的编译"><a href="#lab1的编译" class="headerlink" title="lab1的编译"></a>lab1的编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># systemctl start clash</span></span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span></span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># cd ..</span></span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example<span class="comment"># cd ..</span></span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main<span class="comment"># go mod init deepflow-wasm-go-sdk-main</span></span><br><span class="line">go: creating new go.mod: module deepflow-wasm-go-sdk-main</span><br><span class="line">go: to add module requirements and sums:</span><br><span class="line">        go mod tidy</span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main<span class="comment"># go mod tidy</span></span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/sdk</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb</span><br><span class="line">go: finding module <span class="keyword">for</span> package golang.org/x/net/dns/dnsmessage</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/valyala/fastjson</span><br><span class="line">go: downloading golang.org/x/net v0.17.0</span><br><span class="line">go: downloading github.com/deepflowio/deepflow-wasm-go-sdk v0.0.0-20231016072110-be61afa15717</span><br><span class="line">go: downloading github.com/valyala/fastjson v1.6.4</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/example/krpc/pb</span><br><span class="line">go: finding module <span class="keyword">for</span> package google.golang.org/protobuf/reflect/protoreflect</span><br><span class="line">go: finding module <span class="keyword">for</span> package google.golang.org/protobuf/runtime/protoimpl</span><br><span class="line">go: downloading google.golang.org/protobuf v1.31.0</span><br><span class="line">go: found github.com/deepflowio/deepflow-wasm-go-sdk/sdk <span class="keyword">in</span> github.com/deepflowio/deepflow-wasm-go-sdk v0.0.0-20231016072110-be61afa15717</span><br><span class="line">go: found golang.org/x/net/dns/dnsmessage <span class="keyword">in</span> golang.org/x/net v0.17.0</span><br><span class="line">go: found github.com/valyala/fastjson <span class="keyword">in</span> github.com/valyala/fastjson v1.6.4</span><br><span class="line">go: found github.com/deepflowio/deepflow-wasm-go-sdk/example/krpc/pb <span class="keyword">in</span> github.com/deepflowio/deepflow-wasm-go-sdk v0.0.0-20231016072110-be61afa15717</span><br><span class="line">go: found google.golang.org/protobuf/reflect/protoreflect <span class="keyword">in</span> google.golang.org/protobuf v1.31.0</span><br><span class="line">go: found google.golang.org/protobuf/runtime/protoimpl <span class="keyword">in</span> google.golang.org/protobuf v1.31.0</span><br><span class="line">go: downloading github.com/google/go-cmp v0.5.5</span><br><span class="line">go: downloading golang.org/x/xerrors v0.0.0-20191204190536-9bdfabe68543</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb</span><br><span class="line">go: deepflow-wasm-go-sdk-main/example/go_http2_uprobe imports</span><br><span class="line">        github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb: module github.com/deepflowio/deepflow-wasm-go-sdk@latest found (v0.0.0-20231016072110-be61afa15717), but does not contain package github.com/deepflowio/deepflow-wasm-go-sdk/example/go_http2_uprobe/pb</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># tinygo  build -o wasm.wasm  -target wasi  -panic=trap -scheduler=none -no-debug ./http.go</span></span><br><span class="line">http.go:28:2: no required module provides package github.com/deepflowio/deepflow-wasm-go-sdk/sdk; to add it:</span><br><span class="line">        go get github.com/deepflowio/deepflow-wasm-go-sdk/sdk</span><br><span class="line">http.go:29:2: no required module provides package github.com/valyala/fastjson; to add it:</span><br><span class="line">        go get github.com/valyala/fastjson</span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># go get github.com/deepflowio/deepflow-wasm-go-sdk/sdk</span></span><br><span class="line">go: added github.com/deepflowio/deepflow-wasm-go-sdk v0.0.0-20231016072110-be61afa15717</span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># go get github.com/valyala/fastjson</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231023183554916.png" alt="image-20231023183554916"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># tinygo  build -o wasm.wasm  -target wasi  -panic=trap -scheduler=none -no-debug ./http.go</span></span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># ls</span></span><br><span class="line">http.go  wasm.wasm</span><br></pre></td></tr></table></figure>

<h4 id="插件上传摸索"><a href="#插件上传摸索" class="headerlink" title="插件上传摸索"></a>插件上传摸索</h4><p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027010007823.png" alt="image-20231027010007823"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027010022414.png" alt="image-20231027010022414"></p>
<p>这里可以看到lab1和lab2的agent-group是同一个ID，那么我觉得</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027010104908.png" alt="image-20231027010104908"></p>
<p>这四个agent pod都是由同一个agent-group管理的</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027010257365.png" alt="image-20231027010257365"></p>
<p>这里查看的信息，有个字段VTAP_LCUUIDS，搜到的解释如下：</p>
<ul>
<li><code>VTAP_LCUUIDS</code>：这是一个列表，其中包含了多个虚拟交换机代理（VTAP）的唯一标识符（LCUUID）。每个 VTAP 都有一个唯一的 LCUUID，用于标识该 VTAP。在这个特定的代理组 “default” 中，有多个 VTAP，它们的 LCUUID 被列在这个列表中。</li>
</ul>
<p>虚拟交换机代理（VTAP）通常用于虚拟化网络和安全操作。在您的情况下，这个代理组 “default” 可能与一组虚拟交换机代理相关联，这些代理在网络配置和操作中发挥重要作用。这个字段列出了该代理组所使用的 VTAP 的唯一标识符，以便进行配置和管理，不知道是否跟那四个pod相对应。</p>
<p>看了一下官网，应该是需要自己先创建一个配置文件，然后再通过ID关联</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config example</span><br></pre></td></tr></table></figure>

<p>这个命令可以查看配置文件的默认配置有哪些</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config example &gt; xxxx.yaml</span><br></pre></td></tr></table></figure>

<p>直接给他导到一个yaml文件方便更改</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027010932536.png" alt="image-20231027010932536"></p>
<p>这里我直接用default试一下吧，我现在还存在疑问，既然一个组管理了所有的agent，那么应该不需要其他的组才对。或许其他的组是需要用到多个server的情况？</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027013238000.png" alt="image-20231027013238000"></p>
<p>这里修改一下ID，然后直接创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config create -f agent-group-test1.yaml</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027013454476.png" alt="image-20231027013454476"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config list</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027013613791.png" alt="image-20231027013613791"></p>
<p>然后就能看到配置文件列表了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config list g-6e357a9370 -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027013736194.png" alt="image-20231027013736194"></p>
<p>这个命令也能看到效果了</p>
<p>但是有时候会有这种错误</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027175224410.png" alt="image-20231027175224410"></p>
<p>在浏览器打开grafana界面或者重启就好了，因为有时候有些pod莫名其妙就不行了，也不知道什么原因，可能是虚拟机的问题</p>
<p>这里就直接上传插件试一下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl plugin create  --<span class="built_in">type</span> wasm --image wasm.wasm --name wasm1</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027181236195.png" alt="image-20231027181236195"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027181442254.png" alt="image-20231027181442254"></p>
<p>然后需要更改一下那个配置文件</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027191155068.png" alt="image-20231027191155068"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config update -f your-agent-group-config.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027191643045.png" alt="image-20231027191643045"></p>
<p>然后再查看一下配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config list g-6e357a9370 -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027191722877.png" alt="image-20231027191722877"></p>
<p>查看一下插件是否加载成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8smaster:/home/mobb<span class="comment"># kubectl -n deepflow logs -f deepflow-agent-dqkzv | grep -i plugin</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231027192801114.png" alt="image-20231027192801114"></p>
<p>看起来似乎成功了，去页面看看</p>
<h4 id="lab1插件上传"><a href="#lab1插件上传" class="headerlink" title="lab1插件上传"></a>lab1插件上传</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># deepflow-ctl agent-group list</span></span><br><span class="line">NAME                                            ID</span><br><span class="line">default                                         g-ea50fad06f</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1<span class="comment"># deepflow-ctl agent-group-config list</span></span><br><span class="line">NAME                                           AGENT_GROUP_ID</span><br><span class="line">default                                        g-ea50fad06f</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231101201051652.png" alt="image-20231101201051652"></p>
<p>上传插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># ls</span></span><br><span class="line">http.go  wasm1.wasm</span><br><span class="line">root@lab1:/home/lab1/wasm_plugin/deepflow-wasm-go-sdk-main/example/http<span class="comment"># deepflow-ctl plugin create  --type wasm --image wasm1.wasm --name wasm1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231101200151387.png" alt="image-20231101200151387"></p>
<p>更改插件配置</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231101201503018.png" alt="image-20231101201503018"></p>
<p>更新文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config update -f agent-group-config.yaml</span><br></pre></td></tr></table></figure>

<p>再查看一下配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepflow-ctl agent-group-config list g-ea50fad06f -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231101202005658.png" alt="image-20231101202005658"></p>
<p>然后看一下日志，这里运行的agent pod有这几个</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1<span class="comment"># kubectl get pod -n deepflow</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS       AGE</span><br><span class="line">deepflow-agent-5bs5n                1/1     Running   13 (19m ago)   45d</span><br><span class="line">deepflow-agent-kklnh                1/1     Running   12 (19m ago)   45d</span><br><span class="line">deepflow-agent-sj5n9                1/1     Running   13 (19m ago)   45d</span><br><span class="line">deepflow-agent-wls6w                1/1     Running   14 (19m ago)   45d</span><br><span class="line">deepflow-app-7f69b47dd6-4hv47       1/1     Running   2 (11d ago)    39d</span><br><span class="line">deepflow-clickhouse-0               1/1     Running   12 (11d ago)   45d</span><br><span class="line">deepflow-grafana-84cdcdf594-8n4rd   1/1     Running   14 (11d ago)   11d</span><br><span class="line">deepflow-mysql-6c97f94d8f-pkdsk     1/1     Running   0              11d</span><br><span class="line">deepflow-server-67d9688bdc-tnpsb    1/1     Running   6 (11d ago)    44d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>随便挑一个都是有个，但是这里有报错</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231101203556970.png" alt="image-20231101203556970"></p>
<h1 id="clash启动教程（已部署）"><a href="#clash启动教程（已部署）" class="headerlink" title="clash启动教程（已部署）"></a>clash启动教程（已部署）</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要切换root权限</span></span><br><span class="line">systemctl start clash</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置代理</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否设置成功</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$http_proxy</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$https_proxy</span></span><br><span class="line"><span class="comment">#有127.0.0.1:7890就是设置成功了</span></span><br></pre></td></tr></table></figure>

<h1 id="微服务部署"><a href="#微服务部署" class="headerlink" title="微服务部署"></a>微服务部署</h1><h2 id="部署kubesphere"><a href="#部署kubesphere" class="headerlink" title="部署kubesphere"></a>部署kubesphere</h2><p>参考文档：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41793064/article/details/123111934">k8s创建默认storageclass，解决pvc一直pending问题_k8s pvc pending_阿文_ing的博客-CSDN博客</a></p>
<p>报错，一开始没有默认的storageclashh，所以进行nfs安装</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Entity_G/article/details/125513819">部署kubesphere时需要默认 StorageClass_storageclass default-CSDN博客</a></p>
<p>参考的这个文档，但是这个博主使用的是Centos，需要把其中的换成Ubuntu的指令</p>
<p>1.安装NFS服务器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nfs-kernel-server</span><br></pre></td></tr></table></figure>

<p>2.创建一个要共享的目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p nfs_share</span><br></pre></td></tr></table></figure>

<p>3.给目录增加权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /nfs_share</span><br></pre></td></tr></table></figure>

<p>4.配置 NFS 共享</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br></pre></td></tr></table></figure>

<p>添加以下内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/lab1/nfs_share *(rw,sync,no_root_squash,no_subtree_check)</span><br></pre></td></tr></table></figure>

<p>5.重新启动NFS服务器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nfs-kernel-server</span><br></pre></td></tr></table></figure>

<p>6.创建一个连接nfs服务器的客户端</p>
<ul>
<li><p>配置文件nfs-client.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">10.12</span><span class="number">.52</span><span class="number">.66</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/home/lab1/nfs_share</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">10.12</span><span class="number">.52</span><span class="number">.66</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/home/lab1/nfs_share</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>绑定nfs权限的配置文件（nfs-client-sa.yaml）可以对下面的verbs中列表中参数进行修改来修改权限</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>创建storegeclass对象配置文件（nfs-client-class.yaml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">course-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span> <span class="comment"># 和上图配置文件中PROVISIONER_NAME的一致</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>记住其他四台也需要安装NFS，<strong>以下操作四台都需要进行</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nfs-common</span><br></pre></td></tr></table></figure>

<p>创建挂载的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/tset_mount</span><br></pre></td></tr></table></figure>

<p>将这个文件挂载到lab1的nfs_share上</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs 10.12.52.66:/home/lab1/nfs_share /mnt/test_mount</span><br></pre></td></tr></table></figure>

<p><strong>lab1</strong>进行然后创建资源对象</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nfs-client.yaml</span><br><span class="line">kubectl create -f nfs-client-sa.yaml</span><br><span class="line">kubectl create -f nfs-client-class.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231007134926836.png" alt="image-20231007134926836"></p>
<p>pod和sc都成功了就行了</p>
<p>之后重新部署，此时发生了权限问题</p>
<p><a target="_blank" rel="noopener" href="https://www.kubesphere.io/zh/docs/v3.3/installing-on-kubernetes/introduction/overview/">概述 (kubesphere.io)</a></p>
<p>这个错误信息指出，当尝试应用某些 Kubernetes 对象（特别是 <code>globalrulegroups.alerting.kubesphere.io</code>）时，遇到了权限问题。具体来说，<code>ks-installer</code> 这个 service account 没有足够的权限来获取或修改集群范围内的 <code>globalrulegroups</code> 资源。</p>
<p>错误消息部分为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlCopy code</span><br><span class="line">globalrulegroups.alerting.kubesphere.io &quot;prometheus-operator&quot; is forbidden: User &quot;system:serviceaccount:kubesphere-system:ks-installer&quot; cannot get resource &quot;globalrulegroups&quot; in API group &quot;alerting.kubesphere.io&quot; at the cluster scope</span><br></pre></td></tr></table></figure>

<p>这意味着需要为 <code>ks-installer</code> 这个 service account 授予所需的权限。通常，这是通过 <code>ClusterRole</code> 和 <code>ClusterRoleBinding</code> 来实现的。</p>
<p>这里是一个简化的步骤，以授予 <code>ks-installer</code> 所需的权限：</p>
<ol>
<li>创建一个 <code>ClusterRole</code>，它允许在 <code>alerting.kubesphere.io</code> API 组中的 <code>globalrulegroups</code> 资源上执行所需的操作：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">yamlCopy codeapiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">globalrulegroups-access</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alerting.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">globalrulegroups</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br></pre></td></tr></table></figure>

<ol>
<li>创建一个 <code>ClusterRoleBinding</code>，将上面创建的 <code>ClusterRole</code> 绑定到 <code>ks-installer</code> 这个 service account 上：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">yamlCopy codeapiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer-globalrulegroups-access</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">globalrulegroups-access</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br></pre></td></tr></table></figure>

<p>然后进行资源部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ClusterRole.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f ClusterRoleBinding.yaml</span><br></pre></td></tr></table></figure>

<p>之后再次重新部署，然后查看日志</p>
<p>注：如果发现安装还是找不到默认的storageclass</p>
<p>可以尝试一下执行这个命令，把部署的nfs打上默认的标签</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass course-nfs-storage -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231007135323804.png" alt="image-20231007135323804"></p>
<p>这样就是成功了，可以通过<a href="http://10.12.52.66:30880访问，现在用户名和密码是admin，123456.,Aa">http://10.12.52.66:30880访问，现在用户名和密码是admin，123456.,Aa</a></p>
<h2 id="真·部署kubesphere"><a href="#真·部署kubesphere" class="headerlink" title="真·部署kubesphere"></a>真·部署kubesphere</h2><h3 id="心路历程"><a href="#心路历程" class="headerlink" title="心路历程"></a>心路历程</h3><p>因为上面的只是最小化All-in-one安装，所以并没有什么作用，本来想直接修改cluster-configuration.yaml，但是之后发生了一堆问题，于是干脆删了重装，卸载需要用到官方给的卸载脚本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/blob/release-3.1/scripts/kubesphere-delete.sh">ks-installer/scripts/kubesphere-delete.sh at release-3.1 · kubesphere/ks-installer (github.com)</a></p>
<p>把这个复制然后新建一个sh文件就好了，运行结束后就可以删除了，但是过程相当的漫长，之后</p>
<p>过了一遍安装，但是在deploying minio的时候一直卡住</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TASK [common : KubeSphere | Checking minio] ************************************ changed: [localhost] TASK [common : KubeSphere | Deploying minio] *********************************** </span><br></pre></td></tr></table></figure>



<p>在官方的issues也看到了许多有同样问题的人</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubesphere/issues/5273">Ubuntu 2204 Arm64 安装 v3.3.0 启用插件 一直卡在 Deploying minio · Issue #5273 · kubesphere/kubesphere (github.com)</a></p>
<p>比如这个，但是看到这些全部的问题是因为官方提供的minio镜像是RELEASE.2019-08-07T01-59-21Z ，这个镜像不支持arm架构，这里我就感到奇怪了，Ubuntu20.04不是amd64架构吗（下图所示），但是实在没找到其他解决办法了，就尝试着按照他们的方法来重新搭建，果不其然，不能解决。于是弄了许久，没能解决。</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231015235118342.png" alt="image-20231015235118342"></p>
<p><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.4/pluggable-components/app-store/">KubeSphere 应用商店</a></p>
<p>最后直接又进行了默认安装，但是这里把一些插件打开了，然后搭建成功之后进入平台查看原因，当然也可以通过kubectl describe来看原因，但是用平台比较无脑一点，发现还是说因为没找到默认的pvc，跟</p>
<p>遇到的原因差不多，于是就去搜索找不到pvc怎么办，估计是nfs不够用的原因，后来发现了openEBS，这个可以构建k8s默认的sc，安装完之后，的确是安装成功了，但是监控部分的pod还是没能跑起来，导致还是个空壳服务，甚至于还碰到了controller-manager找不到endpoint(b比如在kube-system下找不到calico之类的，可能是我又设置成localhost了），但是明明我已经改成了master（lab1）的ip了，就是下面的问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Internal error occurred: failed calling webhook &quot;users.iam.kubesphere.io&quot;: failed to call webhook: Post &quot;https://ks-controller-manager.kubesphere-system.svc:443/validate-email-iam-kubesphere-io-v1alpha2?timeout=30s&quot;: no endpoints available for service &quot;ks-controller-manager&quot;</span><br></pre></td></tr></table></figure>

<p>所以还是应该把endpointIps改成10.12.52.66，可能是webhook的原因，（……又是新词汇出现了）</p>
<p>看到了说要删除webhook，我先查询了一下现有的webhook，当然还有个这个网页</p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/kubesphere-3.1-zh/385388">访问控制和帐户管理 - 帐号无法登录 - 《KubeSphere v3.1 使用手册》 - 书栈网 · BookStack</a>，他给的解决办法是一个issue</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubesphere/issues/2928">not working well with Kubernetes 1.19 · Issue #2928 · kubesphere/kubesphere (github.com)</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1<span class="comment">#  kubectl get validatingwebhookconfigurations</span></span><br><span class="line">NAME                                          WEBHOOKS   AGE</span><br><span class="line">istio-validator-1-11-2-istio-system           2          10h</span><br><span class="line">ks-events-admission-validate                  1          97m</span><br><span class="line">network.kubesphere.io                         1          100m</span><br><span class="line">notification-manager-validating-webhook       2          94m</span><br><span class="line">resourcesquotas.quota.kubesphere.io           1          100m</span><br><span class="line">storageclass-accessor.storage.kubesphere.io   1          100m</span><br><span class="line">users.iam.kubesphere.io                       1          100m</span><br><span class="line">validating-webhook-configuration              3          63m</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后那个教程说要删除掉遗留的webhook，那我还不如直接又卸载服务重装，免得删错了，卸载之后发现就剩下了这么个东西，也不知道是干嘛的，总之应该没什么用，然后又开始了重装，这回莫名其妙，就好了？我真的是，不理解计算机这种东西在搞什么东西，这回没有遇到webhook的问题了，怀着忐忑的心情进入页面，期望看到有数据出现，好，结果是令人失望的。那没办法，只能再看看哪里出了问题，发现是prometheus出了问题，那肯定没数据了，kubesphere主要就是用prometheus来做监控，所以看看什么问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@lab1:/home/lab1/kubesphere<span class="comment"># kubectl get validatingwebhookconfigurations</span></span><br><span class="line">NAME                                  WEBHOOKS   AGE</span><br><span class="line">istio-validator-1-11-2-istio-system   2          8h</span><br></pre></td></tr></table></figure>

<p>问题如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MountVolume.SetUp failed <span class="keyword">for</span> volume <span class="string">&quot;secret-kube-etcd-client-certs&quot;</span> : secret <span class="string">&quot;kube-etcd-client-certs&quot;</span> not found</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/a772304419/article/details/113179297">kubesphere解决etcd监控证书找不到问题-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/leifengyang/kubesphere/qcvhx3#rsyTi">02、安装kubesphere v3.0.0 (yuque.com)</a></p>
<p>[MountVolume.SetUp failed for volume “secret-kube-etcd-client-certs” : secret “kube-etcd-client-certs - 知乎 (zhihu.com)](<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/648148640#:~:text=%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A">https://zhuanlan.zhihu.com/p/648148640#:~:text=解决方法：</a> kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs,–from-file%3Detcd-client.crt%3D%2Fetc%2Fkubernetes%2Fpki%2Fetcd%2Fhealthcheck-client.crt  –from-file%3Detcd-client.key%3D%2Fetc%2Fkubernetes%2Fpki%2Fetcd%2Fhealthcheck-client.key 发布于 2023-08-04 20%3A07 ・IP 属地河南)</p>
<p>用的知乎的命令，然后接着等待一会，就好了，真不容易，完整的历时两天的部署。接下来是完整的部署命令：</p>
<h3 id="拉取配置文件"><a href="#拉取配置文件" class="headerlink" title="拉取配置文件"></a>拉取配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/cluster-configuration.yaml</span><br><span class="line"></span><br><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/kubesphere-installer.yaml</span><br></pre></td></tr></table></figure>

<h3 id="配置metric-server"><a href="#配置metric-server" class="headerlink" title="配置metric-server"></a>配置metric-server</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:aggregated-metrics-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/stats</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server-auth-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">extension-apiserver-authentication-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server:system:auth-delegator</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:auth-delegator</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cert-dir=/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=4443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-use-node-status-port</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">metrics-server</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f metrics-server.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231014010522014.png" alt="image-20231014010522014"></p>
<h3 id="安装OpenEBS"><a href="#安装OpenEBS" class="headerlink" title="安装OpenEBS"></a>安装OpenEBS</h3><p><a target="_blank" rel="noopener" href="http://timd.cn/k8s/openebs-installation/">安装OpenEBS (timd.cn)</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node master | grep Taint</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231016002701598.png" alt="image-20231016002701598"></p>
<p>这里我应该是没有删除掉lab1的Taint（因为lab1的Taint好像就是none，所以应该还是要先删掉），但是后续安装没有碰到什么问题。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add openebs https://openebs.github.io/charts</span><br><span class="line">helm repo update</span><br><span class="line">helm install openebs --namespace openebs openebs/openebs --create-namespace</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231015114857869.png" alt="image-20231015114857869"></p>
<p>把 <code>openebs-hostpath</code> 设置为默认的 StorageClass</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass openebs-hostpath -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231127164129536.png" alt="image-20231127164129536"></p>
<p>验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br></pre></td></tr></table></figure>

<h3 id="修改cluster-configuration-yaml"><a href="#修改cluster-configuration-yaml" class="headerlink" title="修改cluster-configuration.yaml"></a>修改cluster-configuration.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">installer.kubesphere.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v3.3.1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span>        <span class="comment"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span></span><br><span class="line">  <span class="attr">authentication:</span></span><br><span class="line">    <span class="comment"># adminPassword: &quot;&quot;     # Custom password of the admin user. If the parameter exists but the value is empty, a random password is generated. If the parameter does not exist, P@88w0rd is used.</span></span><br><span class="line">    <span class="attr">jwtSecret:</span> <span class="string">&quot;&quot;</span>           <span class="comment"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster.</span></span><br><span class="line">  <span class="attr">local_registry:</span> <span class="string">&quot;&quot;</span>        <span class="comment"># Add your private registry address if it is needed.</span></span><br><span class="line">  <span class="comment"># dev_tag: &quot;&quot;               # Add your kubesphere image tag you want to install, by default it&#x27;s same as ks-installer release version.</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">monitoring:</span> <span class="literal">true</span>       <span class="comment"># Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it.</span></span><br><span class="line">    <span class="attr">endpointIps:</span> <span class="number">10.12</span><span class="number">.52</span><span class="number">.66</span> <span class="comment"># etcd cluster EndpointIps. It can be a bunch of IPs here.</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">2379</span>              <span class="comment"># etcd port.</span></span><br><span class="line">    <span class="attr">tlsEnable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="attr">core:</span></span><br><span class="line">      <span class="attr">console:</span></span><br><span class="line">        <span class="attr">enableMultiLogin:</span> <span class="literal">true</span>  <span class="comment"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">30880</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># apiserver:            # Enlarge the apiserver and controller manager&#x27;s resource requests and limits for the large cluster</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># controllerManager:</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enableHA:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span> <span class="comment"># Redis PVC size.</span></span><br><span class="line">    <span class="attr">openldap:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span>   <span class="comment"># openldap PVC size.</span></span><br><span class="line">    <span class="attr">minio:</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">20Gi</span> <span class="comment"># Minio PVC size.</span></span><br><span class="line">    <span class="attr">monitoring:</span></span><br><span class="line">      <span class="comment"># type: external   # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span> <span class="comment"># Prometheus endpoint to get metrics data.</span></span><br><span class="line">      <span class="attr">GPUMonitoring:</span>     <span class="comment"># Enable or disable the GPU-related metrics. If you enable this switch but have no GPU resources, Kubesphere will set it to zero.</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">gpu:</span>                 <span class="comment"># Install GPUKinds. The default GPU kind is nvidia.com/gpu. Other GPU kinds can be added here according to your needs.</span></span><br><span class="line">      <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">resourceName:</span> <span class="string">&quot;nvidia.com/gpu&quot;</span></span><br><span class="line">        <span class="attr">resourceType:</span> <span class="string">&quot;GPU&quot;</span></span><br><span class="line">        <span class="attr">default:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">es:</span>   <span class="comment"># Storage backend for logging, events and auditing.</span></span><br><span class="line">      <span class="comment"># master:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 4Gi  # The volume size of Elasticsearch master nodes.</span></span><br><span class="line">      <span class="comment">#   replicas: 1      # The total number of master nodes. Even numbers are not allowed.</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="comment"># data:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 20Gi  # The volume size of Elasticsearch data nodes.</span></span><br><span class="line">      <span class="comment">#   replicas: 1       # The total number of data nodes.</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="attr">logMaxAge:</span> <span class="number">7</span>             <span class="comment"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span></span><br><span class="line">      <span class="attr">elkPrefix:</span> <span class="string">logstash</span>      <span class="comment"># The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span></span><br><span class="line">      <span class="attr">basicAuth:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchHost:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchPort:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">alerting:</span>                <span class="comment"># (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Alerting System.</span></span><br><span class="line">    <span class="comment"># thanosruler:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">auditing:</span>                <span class="comment"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Auditing Log System.</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># webhook:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">devops:</span>                  <span class="comment"># (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># Enable or disable the KubeSphere DevOps System.</span></span><br><span class="line">    <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">jenkinsMemoryLim:</span> <span class="string">8Gi</span>      <span class="comment"># Jenkins memory limit.</span></span><br><span class="line">    <span class="attr">jenkinsMemoryReq:</span> <span class="string">4Gi</span>   <span class="comment"># Jenkins memory request.</span></span><br><span class="line">    <span class="attr">jenkinsVolumeSize:</span> <span class="string">8Gi</span>     <span class="comment"># Jenkins volume size.</span></span><br><span class="line">  <span class="attr">events:</span>                  <span class="comment"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Events System.</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># exporter:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># ruler:</span></span><br><span class="line">    <span class="comment">#   enabled: true</span></span><br><span class="line">    <span class="comment">#   replicas: 2</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">logging:</span>                 <span class="comment"># (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># Enable or disable the KubeSphere Logging System.</span></span><br><span class="line">    <span class="attr">logsidecar:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">      <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">metrics_server:</span>                    <span class="comment"># (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler).</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>                   <span class="comment"># Enable or disable metrics-server.</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span>                 <span class="comment"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span></span><br><span class="line">    <span class="attr">node_exporter:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">      <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># kube_rbac_proxy:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># kube_state_metrics:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># prometheus:</span></span><br><span class="line">    <span class="comment">#   replicas: 1  # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span></span><br><span class="line">    <span class="comment">#   volumeSize: 20Gi  # Prometheus PVC size.</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># alertmanager:</span></span><br><span class="line">    <span class="comment">#   replicas: 1          # AlertManager Replicas.</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># notification_manager:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   proxy:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">gpu:</span>                           <span class="comment"># GPU monitoring-related plug-in installation.</span></span><br><span class="line">      <span class="attr">nvidia_dcgm_exporter:</span>        <span class="comment"># Ensure that gpu resources on your hosts can be used normally, otherwise this plug-in will not work properly.</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span>             <span class="comment"># Check whether the labels on the GPU hosts contain &quot;nvidia.com/gpu.present=true&quot; to ensure that the DCGM pod is scheduled to these nodes.</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">multicluster:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">none</span>  <span class="comment"># host | member | none  # You can install a solo cluster, or specify it as the Host or Member Cluster.</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">networkpolicy:</span> <span class="comment"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span></span><br><span class="line">      <span class="comment"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># Enable or disable network policies.</span></span><br><span class="line">    <span class="attr">ippool:</span> <span class="comment"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span> <span class="comment"># Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled.</span></span><br><span class="line">    <span class="attr">topology:</span> <span class="comment"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span> <span class="comment"># Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled.</span></span><br><span class="line">  <span class="attr">openpitrix:</span> <span class="comment"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span></span><br><span class="line">    <span class="attr">store:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># Enable or disable the KubeSphere App Store.</span></span><br><span class="line">  <span class="attr">servicemesh:</span>         <span class="comment"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>     <span class="comment"># Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based).</span></span><br><span class="line">    <span class="attr">istio:</span>  <span class="comment"># Customizing the istio installation configuration, refer to https://istio.io/latest/docs/setup/additional-setup/customize-installation/</span></span><br><span class="line">      <span class="attr">components:</span></span><br><span class="line">        <span class="attr">ingressGateways:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">cni:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">edgeruntime:</span>          <span class="comment"># Add edge nodes to your cluster and deploy workloads on edge nodes.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kubeedge:</span>        <span class="comment"># kubeedge configurations</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">cloudCore:</span></span><br><span class="line">        <span class="attr">cloudHub:</span></span><br><span class="line">          <span class="attr">advertiseAddress:</span> <span class="comment"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;&quot;</span>            <span class="comment"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span></span><br><span class="line">        <span class="attr">service:</span></span><br><span class="line">          <span class="attr">cloudhubNodePort:</span> <span class="string">&quot;30000&quot;</span></span><br><span class="line">          <span class="attr">cloudhubQuicNodePort:</span> <span class="string">&quot;30001&quot;</span></span><br><span class="line">          <span class="attr">cloudhubHttpsNodePort:</span> <span class="string">&quot;30002&quot;</span></span><br><span class="line">          <span class="attr">cloudstreamNodePort:</span> <span class="string">&quot;30003&quot;</span></span><br><span class="line">          <span class="attr">tunnelNodePort:</span> <span class="string">&quot;30004&quot;</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">        <span class="comment"># hostNetWork: false</span></span><br><span class="line">      <span class="attr">iptables-manager:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;external&quot;</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">      <span class="comment"># edgeService:</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">gatekeeper:</span>        <span class="comment"># Provide admission policy and rule management, A validating (mutating TBA) webhook that enforces CRD-based policies executed by Open Policy Agent.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>   <span class="comment"># Enable or disable Gatekeeper.</span></span><br><span class="line">    <span class="comment"># controller_manager:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># audit:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">terminal:</span></span><br><span class="line">    <span class="comment"># image: &#x27;alpine:3.15&#x27; # There must be an nsenter program in the image</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span>         <span class="comment"># Container timeout, if set to 0, no timeout will be used. The unit is seconds</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="kubesphere-installer-yaml"><a href="#kubesphere-installer-yaml" class="headerlink" title="kubesphere-installer.yaml"></a>kubesphere-installer.yaml</h3><p>这个文件是不用改的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterconfigurations.installer.kubesphere.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">installer.kubesphere.io</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">      <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">spec:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">x-kubernetes-preserve-unknown-fields:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">status:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">x-kubernetes-preserve-unknown-fields:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">clusterconfigurations</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">clusterconfiguration</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubesphere-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiregistration.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiextensions.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tenant.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">devops.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">logging.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jaegertracing.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storage.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">config.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iam.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">notification.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">auditing.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">core.kubefed.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">installer.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storage.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">security.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.kiali.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kiali.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">edgeruntime.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">types.kubefed.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">application.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ks-installer</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ks-installer</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">ks-installer</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">installer</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubesphere/ks-installer:v3.3.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">&quot;Always&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后进行安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubesphere-installer.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f cluster-configuration.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20231015164410864.png" alt="image-20231015164410864"></p>
<p>成功之后给kube-etcd-client-certs 添加证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs \</span><br><span class="line"> --from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line"> --from-file=etcd-client.crt=/etc/kubernetes/pki/etcd/healthcheck-client.crt \</span><br><span class="line"> --from-file=etcd-client.key=/etc/kubernetes/pki/etcd/healthcheck-client.key</span><br></pre></td></tr></table></figure>

<p>查看证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep kube-apiserver</span><br></pre></td></tr></table></figure>

<p>至此安装完成</p>
<h2 id="部署metarget"><a href="#部署metarget" class="headerlink" title="部署metarget"></a>部署metarget</h2><p>参考18.04的部署步骤</p>
<p>要先安装pip3</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install python3-pip</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/brant-ruan/metarget.git</span><br><span class="line"><span class="built_in">cd</span> metarget/</span><br><span class="line">pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>



<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240310000924624.png" alt="image-20240310000924624"></p>
<h2 id="部署dvwa"><a href="#部署dvwa" class="headerlink" title="部署dvwa"></a>部署dvwa</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget appv install dvwa --external</span><br></pre></td></tr></table></figure>

<h2 id="deepflow升级"><a href="#deepflow升级" class="headerlink" title="deepflow升级"></a>deepflow升级</h2><p>起因是发现deepflow template里面的很多graph不显示内容，询问了之后是因为grafana和init版本不一致的原因。</p>
<p><code>kubectl describe pods -n deepflow deepflow-grafana-xxx | grep Image:</code><br>过滤出目前使用的 init 容器镜像，查看对应版本是否和当前 deepflow 使用的 chart 包版本一致，例如当前 DeepFlow 版本为 v6.4 而使用的 init 容器镜像版本为 latest，则需要把 latest 替换为 v6.4</p>
<p>但是现在的版本是6.3.9的，所以还得重新更新deepflow的版本，这里先拉取的最新的6.4.9的版本，然后</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm fetch deepflow/deepflow --version 6.4.9</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir deepflow-6.4.9-chart &amp;&amp; tar -zxvf deepflow-6.4.9.tgz -C deepflow-6.4.9-chart</span><br></pre></td></tr></table></figure>

<p>然后进入deepflow的文件夹下，修改values.yaml，按理来讲应该是修改下面的部分</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240319143449997.png" alt="image-20240319143449997"></p>
<p>或者说把grafana的这一部分复制到values-custom.yaml里面，然后修改对应版本，但是这样失败了，具体看[<a target="_blank" rel="noopener" href="https://github.com/deepflowio/deepflow/issues/5785">BUG] Error: tag auto_service 未在application, flow_metrics中找到 · Issue #5785 · deepflowio/deepflow (github.com)</a></p>
<p>然后只能直接试下官网的升级</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo update deepflow <span class="comment"># use `helm repo update` when helm &lt; 3.7.0</span></span><br><span class="line">helm upgrade deepflow -n deepflow deepflow/deepflow -f values-custom.yaml</span><br></pre></td></tr></table></figure>

<p>然后这样成功了，但是遗留下了旧版本的grafana，虽然没有影响，因为那个旧版本的会显示ErrImagePull。但是这里出现了lab2的agent显示evicted的问题。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node lab2</span><br></pre></td></tr></table></figure>

<p>这里显示磁盘空间是够的，可能是kubelet的检测出了问题</p>
<p>进到lab2里面查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /var/lib/kubelet/pods/</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240319144014051.png" alt="image-20240319144014051"></p>
<p>查看这些文件的大小</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">du -sh /var/lib/kubelet/pods/*/</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240319144046012.png" alt="image-20240319144046012"></p>
<p>这些文件都很小，应该没什么问题，只能看看磁盘的情况了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@lab2:/home/lab2<span class="comment"># df -h</span></span><br><span class="line">Filesystem                         Size  Used Avail Use% Mounted on</span><br><span class="line">udev                                16G     0   16G   0% /dev</span><br><span class="line">tmpfs                              3.2G  2.1M  3.2G   1% /run</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv   11G  8.5G  1.8G  84% /</span><br><span class="line">tmpfs                               16G     0   16G   0% /dev/shm</span><br><span class="line">tmpfs                              5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs                               16G     0   16G   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0                          92M   92M     0 100% /snap/lxd/24061</span><br><span class="line">/dev/loop3                          41M   41M     0 100% /snap/snapd/20671</span><br><span class="line">/dev/loop1                          64M   64M     0 100% /snap/core20/2105</span><br><span class="line">/dev/loop2                          64M   64M     0 100% /snap/core20/2182</span><br><span class="line">/dev/loop4                          40M   40M     0 100% /snap/snapd/21184</span><br><span class="line">/dev/sda2                          2.0G  210M  1.6G  12% /boot</span><br><span class="line">/dev/sda1                          1.1G  6.1M  1.1G   1% /boot/efi</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/d7fdd48c2ab0a7cfc9aa93274c8ed0ed9563fda1d87f68b5766d2f88a82c1ad2/merged</span><br><span class="line">shm                                 64M     0   64M   0% /var/lib/docker/containers/dc51886418316ecff8f426050475db64aa79a0527234e07d64e40736face5643/mounts/shm</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/ea81ff6c3e0e92808b69ee47f4314daa1db4dff88bff4c42360b77ded4f96b07/merged</span><br><span class="line">tmpfs                               32G  8.0K   32G   1% /var/lib/kubelet/pods/903ba933-aa16-409f-85a5-18ecd118ddaa/volumes/kubernetes.io~secret/node-certs</span><br><span class="line">tmpfs                               32G   12K   32G   1% /var/lib/kubelet/pods/e6b43535-8d05-4c82-befd-845717baa1a2/volumes/kubernetes.io~projected/kube-api-access-w99hs</span><br><span class="line">tmpfs                               32G   12K   32G   1% /var/lib/kubelet/pods/95bfe16a-bfe6-4cbf-8a34-4ad29c3b7a24/volumes/kubernetes.io~projected/kube-api-access-bpsqc</span><br><span class="line">tmpfs                               32G   12K   32G   1% /var/lib/kubelet/pods/903ba933-aa16-409f-85a5-18ecd118ddaa/volumes/kubernetes.io~projected/kube-api-access-8fqvv</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/1fd7cabd4699cf7ef3db520edbd59bddb7d6ae52f5686efb804bcff2ffcd94d0/merged</span><br><span class="line">shm                                 64M     0   64M   0% /var/lib/docker/containers/a3c2c57f316c31d42ef6a4afa22a94bba240642ebbcd3dea863f8a2fcb819719/mounts/shm</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/cada47d3b220d16b7267ae68251c1c50011d87fe682277d715527b02096ee33a/merged</span><br><span class="line">shm                                 64M     0   64M   0% /var/lib/docker/containers/85328751ddd22c222cda023739457bcf5acd0b678dfbf0ef1292c0f6ff517cbe/mounts/shm</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/74b1aeba3c706c3806b65e196a1c7b94642f84ee9dc9f30b153cd4d8810d6aff/merged</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/d6f3ff96abd49b3ed9a5b7825b2c5ba1a84a35e1a86e783f6bb10f2474c6fb0c/merged</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/4eaab31c63033a56974e6fea3ade79d62a453ea9ba8d8adb3ec476d1f8b2de9d/merged</span><br><span class="line">shm                                 64M     0   64M   0% /var/lib/docker/containers/51e189299a7daadce86cab9335732d1c0f20a03406245eee1594e6fa90d8b67d/mounts/shm</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/1b252ff4af7218107c09d008493f295b9a7adfbbd974817ca46d3212d1edc037/merged</span><br><span class="line">overlay                             11G  8.5G  1.8G  84% /var/lib/docker/overlay2/f8904c072a6731c15765ee60acbcb8403aadd2028e86df2496a7917dfd5c6e01/merged</span><br><span class="line">tmpfs                              3.2G     0  3.2G   0% /run/user/1000</span><br></pre></td></tr></table></figure>

<ul>
<li>主分区 <code>/</code>（<code>/dev/mapper/ubuntu--vg-ubuntu--lv</code>）的磁盘使用率达到了 84%，可用空间只有约 1.8G。</li>
<li>系统中有多个挂载在 <code>/var/lib/docker/overlay2/.../merged</code> 下的 Docker 容器层占用大量空间，它们总计也指向了主分区，这可能是导致磁盘压力的主要原因。</li>
</ul>
<ol>
<li><p><strong>清理未使用的 Docker 镜像</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune -a --force</span><br></pre></td></tr></table></figure></li>
<li><p><strong>检查并清理没有被任何容器引用的 Docker 数据卷</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls -qf dangling=<span class="literal">true</span> | xargs -r docker volume rm</span><br></pre></td></tr></table></figure></li>
<li><p><strong>对正在运行的 Kubernetes Pods 进行资源优化</strong>，确保每个 Pod 不过度使用存储资源。</p>
</li>
</ol>
<p>然后再重启lab2的那个agent，暂时是running了</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240319144318736.png" alt="image-20240319144318736"></p>
<p>至于那个旧版的grafana，尝试过了很多办法，缩减了deployment中的pod数量，也还是不行，在不影响使用的情况下就先这样吧。</p>
<h1 id="ubuntu18-04"><a href="#ubuntu18-04" class="headerlink" title="ubuntu18.04"></a>ubuntu18.04</h1><p>注意版本对应，sealos的仓库没有helm3.6.x版本的，所以得自己安装了</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaoyuechen/p/16851216.html">calico 版本和k8s版本对应路径网址查看 - 滴滴滴 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhaowenyu.com/helm-doc/install/helm-k8s-version-relation.html">Helm 版本与 K8s 版本对应关系 · Helm</a></p>
<p>去官网下载对应二进制版本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases?page=5">Releases · helm/helm (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install/">Helm | Installing Helm</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lab@lab:~/helm$ tar -zxvf helm-v3.6.1-linux-amd64.tar.gz</span><br><span class="line">linux-amd64/</span><br><span class="line">linux-amd64/helm</span><br><span class="line">linux-amd64/LICENSE</span><br><span class="line">linux-amd64/README.md</span><br><span class="line">lab@lab:~/helm$ mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">mv: cannot move &#x27;linux-amd64/helm&#x27; to &#x27;/usr/local/bin/helm&#x27;: Permission denied</span><br><span class="line">lab@lab:~/helm$ sudo mv linux-amd64/helm /usr/local/bin/helm</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240308205822651.png" alt="image-20240308205822651"></p>
<p>这个虚拟机ip会变（血的教训），需要固定ip</p>
<p>之前的版本网卡配置信息配置在/etc/network/interfaces文件，可以如下配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">auto</span> <span class="string">ens33</span></span><br><span class="line"><span class="string">iface</span> <span class="string">ens33</span> <span class="string">inet</span> <span class="string">static</span></span><br><span class="line"><span class="string">address</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.111</span></span><br><span class="line"><span class="string">netmask</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line"><span class="string">gateway</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>在18.04上也是可以用的，只是要重启才能生效。通过service networking restart无效。</p>
<p>下面介绍一下在18.04上新采用的netplan命令。网卡信息配置在/etc/netplan/01-network-manager-all.yaml文件，需做如下配置，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Let</span> <span class="string">NetworkManager</span> <span class="string">manage</span> <span class="string">all</span> <span class="string">devices</span> <span class="string">on</span> <span class="string">this</span> <span class="string">system</span></span><br><span class="line"></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">renderer:</span> <span class="string">NetworkManager</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">          <span class="attr">ens33:</span></span><br><span class="line">                  <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.0</span><span class="number">.111</span><span class="string">/24</span>]</span><br><span class="line">                  <span class="attr">gateway4:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">                  <span class="attr">nameservers:</span></span><br><span class="line">                        <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>]</span><br></pre></td></tr></table></figure>



<p>然后使用以下命令使配置即时生效，</p>
<p><code>netplan apply</code></p>
<p>用sealos安装k8s</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos run labring/kubernetes-docker:v1.21.8 labring/calico:v3.22.1      --masters 192.168.52.134</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join apiserver.cluster.local:6443 --token &lt;value withheld&gt; \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:f7cd1b4ea77032eb3541ed8e7d32ebba9651a8c964d1fb45f2e77e60ac9b5e2e \</span><br><span class="line">        --control-plane --certificate-key &lt;value withheld&gt;</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join apiserver.cluster.local:6443 --token &lt;value withheld&gt; \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:f7cd1b4ea77032eb3541ed8e7d32ebba9651a8c964d1fb45f2e77e60ac9b5e2e</span><br><span class="line">2024-03-08T20:46:48 info Executing pipeline Join <span class="keyword">in</span> CreateProcessor.</span><br><span class="line">2024-03-08T20:46:48 info Executing pipeline RunGuest <span class="keyword">in</span> CreateProcessor.</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/apiservers.operator.tigera.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/imagesets.operator.tigera.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/installations.operator.tigera.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/tigerastatuses.operator.tigera.io created</span><br><span class="line">namespace/tigera-operator created</span><br><span class="line">Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="keyword">in</span> v1.21+, unavailable <span class="keyword">in</span> v1.25+</span><br><span class="line">podsecuritypolicy.policy/tigera-operator created</span><br><span class="line">serviceaccount/tigera-operator created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/tigera-operator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tigera-operator created</span><br><span class="line">deployment.apps/tigera-operator created</span><br><span class="line">installation.operator.tigera.io/default created</span><br><span class="line">2024-03-08T20:46:56 info succeeded <span class="keyword">in</span> creating a new cluster, enjoy it!</span><br><span class="line">2024-03-08T20:46:56 info</span><br><span class="line">      ___           ___           ___           ___       ___           ___</span><br><span class="line">     /\  \         /\  \         /\  \         /\__\     /\  \         /\  \</span><br><span class="line">    /::\  \       /::\  \       /::\  \       /:/  /    /::\  \       /::\  \</span><br><span class="line">   /:/\ \  \     /:/\:\  \     /:/\:\  \     /:/  /    /:/\:\  \     /:/\ \  \</span><br><span class="line">  _\:\~\ \  \   /::\~\:\  \   /::\~\:\  \   /:/  /    /:/  \:\  \   _\:\~\ \  \</span><br><span class="line"> /\ \:\ \ \__\ /:/\:\ \:\__\ /:/\:\ \:\__\ /:/__/    /:/__/ \:\__\ /\ \:\ \ \__\</span><br><span class="line"> \:\ \:\ \/__/ \:\~\:\ \/__/ \/__\:\/:/  / \:\  \    \:\  \ /:/  / \:\ \:\ \/__/</span><br><span class="line">  \:\ \:\__\    \:\ \:\__\        \::/  /   \:\  \    \:\  /:/  /   \:\ \:\__\</span><br><span class="line">   \:\/:/  /     \:\ \/__/        /:/  /     \:\  \    \:\/:/  /     \:\/:/  /</span><br><span class="line">    \::/  /       \:\__\         /:/  /       \:\__\    \::/  /       \::/  /</span><br><span class="line">     \/__/         \/__/         \/__/         \/__/     \/__/         \/__/</span><br><span class="line"></span><br><span class="line">                  Website: https://www.sealos.io/</span><br><span class="line">                  Address: github.com/labring/sealos</span><br><span class="line">                  Version: 4.3.2-3d1cbf6c</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240309003252669.png" alt="image-20240309003252669"></p>
<h2 id="部署metarget-1"><a href="#部署metarget-1" class="headerlink" title="部署metarget"></a>部署metarget</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/brant-ruan/metarget.git</span><br><span class="line"><span class="built_in">cd</span> metarget/</span><br><span class="line">pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>必须得是pip3，pip没有docker源</p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240309011030625.png" alt="image-20240309011030625"></p>
<h2 id="部署dvwa-1"><a href="#部署dvwa-1" class="headerlink" title="部署dvwa"></a>部署dvwa</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget appv install dvwa --external</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240309012534652.png" alt="image-20240309012534652"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240309012700351.png" alt="image-20240309012700351"></p>
<p><img src="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/image-20240309014335775.png" alt="image-20240309014335775"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">mobb</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/">http://example.com/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">All about secret</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/26/TED-learning/"><img class="prev-cover" src="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TED learning</div></div></a></div><div class="next-post pull-right"><a href="/2023/07/30/%E5%A4%A7%E5%88%9B%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0/"><img class="next-cover" src="/2023/07/30/%E5%A4%A7%E5%88%9B%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0/%E6%94%BE%E5%AD%A6%E8%B7%AF%E4%B8%8A%E7%9A%84%E6%97%A5%E5%BC%8F%E5%B0%8F%E8%B0%83.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大创基本知识学习</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mobb</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2k8s1-23-8"><span class="toc-number">1.</span> <span class="toc-text">部署k8s1.23.8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.1.</span> <span class="toc-text">初始工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap"><span class="toc-number">1.2.</span> <span class="toc-text">关闭swap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%97%B6%E9%97%B4"><span class="toc-number">1.3.</span> <span class="toc-text">同步时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8sealos%E5%AE%89%E8%A3%85k8s"><span class="toc-number">1.4.</span> <span class="toc-text">使用sealos安装k8s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">1.5.</span> <span class="toc-text">部署dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2deepflow"><span class="toc-number">1.6.</span> <span class="toc-text">部署deepflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4deepflow"><span class="toc-number">1.7.</span> <span class="toc-text">删除deepflow</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%AB%99%E5%9C%A8%E8%BF%99"><span class="toc-number">2.</span> <span class="toc-text">学习网站在这</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ebpf%E5%AE%98%E7%BD%91"><span class="toc-number">2.1.</span> <span class="toc-text">ebpf官网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ebpf%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98"><span class="toc-number">2.2.</span> <span class="toc-text">ebpf入门实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-eBPF-%E7%9A%84%E9%AB%98%E5%BA%A6%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.3.</span> <span class="toc-text">基于 eBPF 的高度自动化可观测性实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deepflow%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">deepflow高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server"><span class="toc-number">2.4.1.</span> <span class="toc-text">Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent"><span class="toc-number">2.4.2.</span> <span class="toc-text">Agent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98"><span class="toc-number">2.5.</span> <span class="toc-text">Linux性能优化实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ebpf%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.6.</span> <span class="toc-text">ebpf学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ebpf%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA"><span class="toc-number">2.6.1.</span> <span class="toc-text">ebpf深入浅出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eBPF-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98"><span class="toc-number">2.6.2.</span> <span class="toc-text">eBPF 核心技术与实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAeBPF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%88%E5%9C%A8%E4%BB%96%E7%BB%99%E7%9A%84docker%E5%AE%B9%E5%99%A8%E9%87%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E6%98%AF%E4%B8%8D%E9%9C%80%E8%A6%81%E6%90%AD%E5%BB%BA%E7%9A%84%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">搭建eBPF开发环境（在他给的docker容器里实际上是不需要搭建的）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%EF%BC%9A%E4%BB%8E%E4%B8%8B%E9%9D%A2%E5%BC%80%E5%A7%8B%EF%BC%8C%E5%88%B0%E5%88%86%E5%89%B2%E7%BA%BF%E7%9A%84%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%E5%9D%87%E5%8F%AF%E4%B8%8D%E5%81%9A%E5%8F%82%E8%80%83"><span class="toc-number">2.7.1.</span> <span class="toc-text">注：从下面开始，到分割线的所有内容均可不做参考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E6%98%AF%E5%88%86%E5%89%B2%E7%BA%BF"><span class="toc-number">2.7.2.</span> <span class="toc-text">我是分割线</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84eBPF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.8.</span> <span class="toc-text">真正的eBPF开发环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bpftool"><span class="toc-number">2.9.</span> <span class="toc-text">bpftool</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Agent%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">Agent调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91"><span class="toc-number">3.1.</span> <span class="toc-text">源码编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-agent-benches%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">3.2.</span> <span class="toc-text">分析&#x2F;agent&#x2F;benches文件夹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Go%E4%BB%A5%E5%8F%8ATinyGo"><span class="toc-number">3.3.</span> <span class="toc-text">安装Go以及TinyGo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0wasm%E6%8F%92%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">上传wasm插件测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lab1%E7%9A%84%E7%BC%96%E8%AF%91"><span class="toc-number">3.4.1.</span> <span class="toc-text">lab1的编译</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%91%B8%E7%B4%A2"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">插件上传摸索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lab1%E6%8F%92%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">lab1插件上传</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#clash%E5%90%AF%E5%8A%A8%E6%95%99%E7%A8%8B%EF%BC%88%E5%B7%B2%E9%83%A8%E7%BD%B2%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">clash启动教程（已部署）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">微服务部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubesphere"><span class="toc-number">5.1.</span> <span class="toc-text">部署kubesphere</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%C2%B7%E9%83%A8%E7%BD%B2kubesphere"><span class="toc-number">5.2.</span> <span class="toc-text">真·部署kubesphere</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">心路历程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.2.</span> <span class="toc-text">拉取配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEmetric-server"><span class="toc-number">5.2.3.</span> <span class="toc-text">配置metric-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85OpenEBS"><span class="toc-number">5.2.4.</span> <span class="toc-text">安装OpenEBS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9cluster-configuration-yaml"><span class="toc-number">5.2.5.</span> <span class="toc-text">修改cluster-configuration.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubesphere-installer-yaml"><span class="toc-number">5.2.6.</span> <span class="toc-text">kubesphere-installer.yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2metarget"><span class="toc-number">5.3.</span> <span class="toc-text">部署metarget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dvwa"><span class="toc-number">5.4.</span> <span class="toc-text">部署dvwa</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deepflow%E5%8D%87%E7%BA%A7"><span class="toc-number">5.5.</span> <span class="toc-text">deepflow升级</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ubuntu18-04"><span class="toc-number">6.</span> <span class="toc-text">ubuntu18.04</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2metarget-1"><span class="toc-number">6.1.</span> <span class="toc-text">部署metarget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dvwa-1"><span class="toc-number">6.2.</span> <span class="toc-text">部署dvwa</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/19/%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="爬虫学习记录"><img src="/2024/11/19/%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="爬虫学习记录"/></a><div class="content"><a class="title" href="/2024/11/19/%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="爬虫学习记录">爬虫学习记录</a><time datetime="2024-11-19T15:46:07.000Z" title="发表于 2024-11-19 23:46:07">2024-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/14/Intel-64-IA-32-Program-Note/" title="Intel-64-IA-32-Program-Note"><img src="/2024/11/14/Intel-64-IA-32-Program-Note/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Intel-64-IA-32-Program-Note"/></a><div class="content"><a class="title" href="/2024/11/14/Intel-64-IA-32-Program-Note/" title="Intel-64-IA-32-Program-Note">Intel-64-IA-32-Program-Note</a><time datetime="2024-11-14T02:22:25.000Z" title="发表于 2024-11-14 10:22:25">2024-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/09/%E5%BE%AE%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0%E9%9B%86/" title="微架构安全论文学习集"><img src="/2024/10/09/%E5%BE%AE%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0%E9%9B%86/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="微架构安全论文学习集"/></a><div class="content"><a class="title" href="/2024/10/09/%E5%BE%AE%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0%E9%9B%86/" title="微架构安全论文学习集">微架构安全论文学习集</a><time datetime="2024-10-09T02:47:23.000Z" title="发表于 2024-10-09 10:47:23">2024-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="计算机系统结构学习笔记"><img src="/2024/09/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机系统结构学习笔记"/></a><div class="content"><a class="title" href="/2024/09/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="计算机系统结构学习笔记">计算机系统结构学习笔记</a><time datetime="2024-09-16T08:52:10.000Z" title="发表于 2024-09-16 16:52:10">2024-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/03/%E6%96%87%E7%8C%AE%E6%9F%A5%E6%89%BE%E6%94%BB%E7%95%A5/" title="文献查找攻略"><img src="/2024/07/03/%E6%96%87%E7%8C%AE%E6%9F%A5%E6%89%BE%E6%94%BB%E7%95%A5/bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文献查找攻略"/></a><div class="content"><a class="title" href="/2024/07/03/%E6%96%87%E7%8C%AE%E6%9F%A5%E6%89%BE%E6%94%BB%E7%95%A5/" title="文献查找攻略">文献查找攻略</a><time datetime="2024-07-03T12:05:27.000Z" title="发表于 2024-07-03 20:05:27">2024-07-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/2024/03/14/%E5%A4%A7%E5%88%9B%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By mobb</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>